<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commodity Trade Tracker</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Custom vertical scrollbar for dark theme */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px; /* Added height for horizontal */
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        /* Custom horizontal scrollbar for nav */
        nav::-webkit-scrollbar {
            height: 4px; /* Slimmer scrollbar for nav */
        }
        nav::-webkit-scrollbar-track {
            background: transparent; /* Make nav scrollbar track invisible */
        }
        nav::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 10px;
        }

        /* Style for hidden views */
        .page-view, .report-page-view {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4 sm:p-8">

    <div id="app" class="max-w-6xl mx-auto pt-4">

        <!-- NEW: Auth Container (Login / Register) - Shown by default -->
        <div id="auth-container">
            <!-- Login View -->
            <div id="login-view" class="page-view max-w-md mx-auto bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl border border-gray-700">
                <h2 class="text-3xl font-bold text-center text-white mb-6">Login</h2>
                <form id="login-form" class="space-y-4">
                    <div>
                        <!-- CHANGED from Username to Mobile Number -->
                        <label for="login-username" class="block text-sm font-medium text-gray-300 mb-1">Mobile Number</label>
                        <input type="tel" id="login-username" required placeholder="Enter 10-digit number"
                               class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-300 mb-1">Password</label>
                        <input type="password" id="login-password" required
                               class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                    </div>
                    <p id="login-error" class="text-red-400 text-sm hidden"></p>
                    <button type="submit" id="login-button"
                            class="w-full py-2 px-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-md transition duration-150">
                        Login
                    </button>
                </form>
                <p class="text-center text-sm text-gray-400 mt-6">
                    Don't have an account? 
                    <a href="#register" id="goto-register-link" class="font-medium text-blue-400 hover:underline">Sign Up</a>
                </p>
            </div>

            <!-- Register View -->
            <div id="register-view" class="page-view max-w-md mx-auto bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl border border-gray-700">
                <h2 class="text-3xl font-bold text-center text-white mb-6">Create Account</h2>
                <form id="register-form" class="space-y-4">
                    <div>
                        <!-- CHANGED from Username to Mobile Number -->
                        <label for="register-username" class="block text-sm font-medium text-gray-300 mb-1">Mobile Number</label>
                        <input type="tel" id="register-username" required minlength="10" maxlength="10" placeholder="Enter 10-digit number"
                               class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                    </div>
                    <div>
                        <label for="register-password" class="block text-sm font-medium text-gray-300 mb-1">Password</label>
                        <input type="password" id="register-password" required minlength="6"
                               class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                    </div>
                    <p id="register-error" class="text-red-400 text-sm hidden"></p>
                    <button type="submit" id="register-button"
                            class="w-full py-2 px-4 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg shadow-md transition duration-150">
                        Create Account
                    </button>
                </form>
                <p class="text-center text-sm text-gray-400 mt-6">
                    Already have an account? 
                    <a href="#login" id="goto-login-link" class="font-medium text-blue-400 hover:underline">Login</a>
                </p>
            </div>
        </div>

        <!-- NEW: Main App Container - Hidden by default -->
        <div id="main-app-container" class="hidden">
            <!-- Navigation Bar -->
            <nav class="mb-6 p-2 bg-gray-800 rounded-xl shadow-lg flex justify-start flex-nowrap overflow-x-auto space-x-2 sm:space-x-4 border border-gray-700"> 
                <a href="#dashboard" id="nav-dashboard" class="nav-link py-2 px-4 rounded-lg font-semibold text-gray-300 hover:bg-gray-700 transition duration-150 whitespace-nowrap">
                    Dashboard
                </a>
                <a href="#gold" id="nav-gold" class="nav-link py-2 px-4 rounded-lg font-semibold text-gray-300 hover:bg-gray-700 transition duration-150 whitespace-nowrap">
                    Gold Mini
                </a>
                <a href="#silver" id="nav-silver" class="nav-link py-2 px-4 rounded-lg font-semibold text-gray-300 hover:bg-gray-700 transition duration-150 whitespace-nowrap">
                    Silver Mini
                </a>
                <a href="#report" id="nav-report" class="nav-link py-2 px-4 rounded-lg font-semibold text-gray-300 hover:bg-gray-700 transition duration-150 whitespace-nowrap">
                    Report
                </a>
                <!-- Renamed Settings to Profile -->
                <a href="#profile" id="nav-profile" class="nav-link py-2 px-4 rounded-lg font-semibold text-gray-300 hover:bg-gray-700 transition duration-150 whitespace-nowrap">
                    Profile
                </a>
            </nav>
            
            <!-- DASHBOARD VIEW (Home Page) -->
            <div id="dashboard-view" class="page-view">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    
                    <!-- New Gold Card -->
                    <div class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700">
                        <h2 class="text-xl font-bold text-yellow-400 mb-4">Gold Mini - Current Week</h2>
                        <div class="flex justify-around items-center space-x-4">
                            <!-- Avg Buy -->
                            <div class="text-center">
                                <p class="text-sm font-medium text-green-400 uppercase">Avg. Buy</p>
                                <p id="gold-avg-buy" class="text-3xl sm:text-4xl font-extrabold text-green-400 mt-1">0.00</p>
                            </div>
                            <!-- Avg Sell -->
                            <div class="text-center">
                                <p class="text-sm font-medium text-red-400 uppercase">Avg. Sell</p>
                                <p id="gold-avg-sell" class="text-3xl sm:text-4xl font-extrabold text-red-400 mt-1">0.00</p>
                            </div>
                        </div>
                        <p id="gold-trade-count" class="text-sm text-gray-400 mt-4 text-center">Based on 0 trades this week.</p>
                    </div>

                    <!-- New Silver Card -->
                    <div class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700">
                        <h2 class="text-xl font-bold text-gray-300 mb-4">Silver Mini - Current Week</h2>
                        <div class="flex justify-around items-center space-x-4">
                            <!-- Avg Buy -->
                            <div class="text-center">
                                <p class="text-sm font-medium text-green-400 uppercase">Avg. Buy</p>
                                <p id="silver-avg-buy" class="text-3xl sm:text-4xl font-extrabold text-green-400 mt-1">0.00</p>
                            </div>
                            <!-- Avg Sell -->
                            <div class="text-center">
                                <p class="text-sm font-medium text-red-400 uppercase">Avg. Sell</p>
                                <p id="silver-avg-sell" class="text-3xl sm:text-4xl font-extrabold text-red-400 mt-1">0.00</p>
                            </div>
                        </div>
                        <p id="silver-trade-count" class="text-sm text-gray-400 mt-4 text-center">Based on 0 trades this week.</p>
                    </div>

                </div>

                <!-- NEW: Gemini Market Insights Card -->
                <div id="market-insights-card" class="mt-6 bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700">
                    <h2 class="text-2xl font-bold text-blue-400 mb-4">âœ¨ Market Insights</h2>
                    <button id="get-market-insights-button" class="w-full sm:w-auto py-2 px-5 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-md transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                        Get Latest News
                    </button>
                    
                    <!-- Loading Spinner -->
                    <div id="insights-loading" class="hidden mt-4 flex justify-center items-center">
                        <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-400"></div>
                        <p class="ml-3 text-gray-300">Fetching live market data...</p>
                    </div>

                    <!-- AI Content Area -->
                    <div id="insights-content" class="mt-4 text-gray-300 text-sm leading-relaxed">
                        <!-- AI-generated content will appear here -->
                    </div>
                    
                    <!-- AI Sources Area -->
                    <div id="insights-sources" class="mt-4 text-xs">
                        <!-- AI-generated sources will appear here -->
                    </div>
                </div>

            </div>

            <!-- GOLD MINI TRADE ENTRY VIEW -->
            <div id="gold-view" class="page-view">
                <!-- Gold Trade Entry Form -->
                <div class="bg-gray-800 p-4 sm:p-6 rounded-xl shadow-2xl mb-8 border border-yellow-700">
                    <h2 class="text-2xl font-semibold mb-4 text-yellow-400">New Gold Mini Trade (100g)</h2>
                    <form id="gold-trade-form" class="grid grid-cols-2 gap-4 sm:grid-cols-3 sm:gap-6">
                        <div class="col-span-1">
                            <label for="gold-buy-amount" class="block text-sm font-medium text-green-400 mb-1">Buy Rate (per 10g)</label>
                            <input type="number" id="gold-buy-amount" placeholder="Rate per 10g" step="any" min="0"
                                   class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-green-500 focus:border-green-500 transition duration-150">
                        </div>
                        <div class="col-span-1">
                            <label for="gold-sell-amount" class="block text-sm font-medium text-red-400 mb-1">Sell Rate (per 10g)</label>
                            <input type="number" id="gold-sell-amount" placeholder="Rate per 10g" step="any" min="0"
                                   class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-red-500 focus:border-red-500 transition duration-150">
                        </div>
                        <div class="col-span-2 sm:col-span-1 flex items-end">
                            <button type="submit" id="gold-submit-button" disabled
                                    class="w-full py-2 px-4 bg-yellow-600 hover:bg-yellow-500 text-gray-900 font-bold rounded-lg shadow-md transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                                Add Gold Trade
                            </button>
                        </div>
                    </form>
                    <p id="gold-error-message" class="text-red-400 text-sm mt-3 hidden"></p>
                </div>
                <!-- Gold Trades Table -->
                <div class="bg-gray-800 p-4 sm:p-6 rounded-xl shadow-2xl border border-gray-700">
                    <h2 class="text-2xl font-semibold mb-4 text-white">Gold Trade History</h2>
                    <div class="overflow-x-auto rounded-lg">
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Week</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Date</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-green-400 uppercase tracking-wider">Buy Rate (10g)</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-red-400 uppercase tracking-wider">Sell Rate (10g)</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="gold-trades-body" class="bg-gray-800 divide-y divide-gray-700">
                                <tr><td colspan="5" class="px-3 py-4 text-center text-sm text-gray-400" id="gold-loading-message">Loading trades...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- SILVER MINI TRADE ENTRY VIEW -->
            <div id="silver-view" class="page-view">
                <!-- Silver Trade Entry Form -->
                <div class="bg-gray-800 p-4 sm:p-6 rounded-xl shadow-2xl mb-8 border border-gray-600">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-300">New Silver Mini Trade (5kg)</h2>
                    <form id="silver-trade-form" class="grid grid-cols-2 gap-4 sm:grid-cols-3 sm:gap-6">
                        <div class="col-span-1">
                            <label for="silver-buy-amount" class="block text-sm font-medium text-green-400 mb-1">Buy Rate (per 1kg)</label>
                            <input type="number" id="silver-buy-amount" placeholder="Rate per 1kg" step="any" min="0"
                                   class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-green-500 focus:border-green-500 transition duration-150">
                        </div>
                        <div class="col-span-1">
                            <label for="silver-sell-amount" class="block text-sm font-medium text-red-400 mb-1">Sell Rate (per 1kg)</label>
                            <input type="number" id="silver-sell-amount" placeholder="Rate per 1kg" step="any" min="0"
                                   class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-red-500 focus:border-red-500 transition duration-150">
                        </div>
                        <div class="col-span-2 sm:col-span-1 flex items-end">
                            <button type="submit" id="silver-submit-button" disabled
                                    class="w-full py-2 px-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-md transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                                Add Silver Trade
                            </button>
                        </div>
                    </form>
                    <p id="silver-error-message" class="text-red-400 text-sm mt-3 hidden"></p>
                </div>
                <!-- Silver Trades Table -->
                <div class="bg-gray-800 p-4 sm:p-6 rounded-xl shadow-2xl border border-gray-700">
                    <h2 class="text-2xl font-semibold mb-4 text-white">Silver Trade History</h2>
                    <div class="overflow-x-auto rounded-lg">
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Week</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Date</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-green-400 uppercase tracking-wider">Buy Rate (1kg)</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-red-400 uppercase tracking-wider">Sell Rate (1kg)</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="silver-trades-body" class="bg-gray-800 divide-y divide-gray-700">
                                <tr><td colspan="5" class="px-3 py-4 text-center text-sm text-gray-400" id="silver-loading-message">Loading trades...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- REPORT VIEW -->
            <div id="report-view" class="page-view">
                <!-- Report Sub-Navigation -->
                <nav id="report-sub-nav" class="mb-4 p-2 bg-gray-800 rounded-xl shadow-lg flex justify-start flex-nowrap overflow-x-auto space-x-2 sm:space-x-4 border border-gray-700">
                    <a href="#report-overall" class="report-nav-link py-2 px-4 rounded-lg font-semibold text-gray-300 hover:bg-gray-700 transition duration-150 whitespace-nowrap">
                        Overall P&L
                    </a>
                    <a href="#report-gold" class="report-nav-link py-2 px-4 rounded-lg font-semibold text-gray-300 hover:bg-gray-700 transition duration-150 whitespace-nowrap">
                        Gold Net Position
                    </a>
                    <a href="#report-silver" class="report-nav-link py-2 px-4 rounded-lg font-semibold text-gray-300 hover:bg-gray-700 transition duration-150 whitespace-nowrap">
                        Silver Net Position
                    </a>
                </nav>

                <!-- NEW: Overall P&L Report View (Replaces Scroller) -->
                <div id="report-overall-view" class="report-page-view">
                    <div class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700">
                        <h2 class="text-2xl font-bold text-green-400 mb-6">Overall Realized Profit & Loss</h2>
                        <div class="overflow-x-auto rounded-lg">
                            <table class="min-w-full divide-y divide-gray-700">
                                <thead class="bg-gray-700">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Item</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">P&L (Gold)</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">P&L (Silver)</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">Total P&L</th>
                                    </tr>
                                </thead>
                                <tbody id="pl-report-body" class="bg-gray-800 divide-y divide-gray-700">
                                    <!-- Rows will be injected by JS -->
                                </tbody>
                            </table>
                            <p id="pl-report-loading" class="text-center text-gray-400 p-4">Calculating P&L...</p>
                        </div>
                    </div>
                </div>

                <!-- Gold-Only Report View (Shows Net Position) -->
                <div id="report-gold-view" class="report-page-view">
                    <div class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700">
                        <h2 class="text-2xl font-bold text-yellow-400 mb-6">Gold Mini Report</h2>
                        <!-- NEW: Detailed Table -->
                        <div class="overflow-x-auto rounded-lg">
                            <table class="min-w-full divide-y divide-gray-700">
                                <thead class="bg-gray-700">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Metric</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">Average</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">Total</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-gray-800 divide-y divide-gray-700">
                                    <tr>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-green-400">Buy</td>
                                        <td id="gold-avg-buy-report" class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium text-green-400">0.00</td>
                                        <td id="gold-total-buy-report" class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium text-green-400">0.00</td>
                                    </tr>
                                    <tr>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-red-400">Sell</td>
                                        <td id="gold-avg-sell-report" class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium text-red-400">0.00</td>
                                        <td id="gold-total-sell-report" class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium text-red-400">0.00</td>
                                    </tr>
                                    <tr class="bg-gray-700">
                                        <td class="px-4 py-4 whitespace-nowrap text-sm font-bold text-white">Realized Profit/Loss</td>
                                        <!-- UPDATED: Made this clickable -->
                                        <td colspan="2" id="gold-pl-report" 
                                            class="pl-details-button px-4 py-4 whitespace-nowrap text-right text-sm font-bold text-white cursor-pointer hover:underline"
                                            data-commodity="gold"
                                            data-week="all"
                                            title="Click to see details">
                                            0.00
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Silver-Only Report View (Shows Net Position) -->
                <div id="report-silver-view" class="report-page-view">
                    <div class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700">
                        <h2 class="text-2xl font-bold text-gray-300 mb-6">Silver Mini Report</h2>
                        <!-- NEW: Detailed Table -->
                        <div class="overflow-x-auto rounded-lg">
                            <table class="min-w-full divide-y divide-gray-700">
                                <thead class="bg-gray-700">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Metric</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">Average</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">Total</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-gray-800 divide-y divide-gray-700">
                                    <tr>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-green-400">Buy</td>
                                        <td id="silver-avg-buy-report" class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium text-green-400">0.00</td>
                                        <td id="silver-total-buy-report" class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium text-green-400">0.00</td>
                                    </tr>
                                    <tr>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-red-400">Sell</td>
                                        <td id="silver-avg-sell-report" class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium text-red-400">0.00</td>
                                        <td id="silver-total-sell-report" class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium text-red-400">0.00</td>
                                    </tr>
                                    <tr class="bg-gray-700">
                                        <td class="px-4 py-4 whitespace-nowrap text-sm font-bold text-white">Realized Profit/Loss</td>
                                        <!-- UPDATED: Made this clickable -->
                                        <td colspan="2" id="silver-pl-report" 
                                            class="pl-details-button px-4 py-4 whitespace-nowrap text-right text-sm font-bold text-white cursor-pointer hover:underline"
                                            data-commodity="silver"
                                            data-week="all"
                                            title="Click to see details">
                                            0.00
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PROFILE & SETTINGS VIEW (Replaced Settings) -->
            <div id="profile-view" class="page-view">
                <div class="space-y-6">
                    <div class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700">
                        <h2 class="text-2xl font-bold text-blue-400 mb-6">Profile & Settings</h2>
                        
                        <!-- Profile Info -->
                        <div class="max-w-md mb-8">
                            <h3 class="text-lg font-semibold text-white mb-2">Account</h3>
                            <p class="text-gray-400 text-sm mb-2">
                                <!-- CHANGED from Username to Mobile Number -->
                                Mobile Number: <span id="user-username-display" class="font-bold text-yellow-400"></span>
                            </p>
                            <button id="sign-out-button" class="w-full mt-4 py-2 px-4 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-lg shadow-md transition duration-150">
                                Sign Out
                            </button>
                        </div>

                        <!-- NEW: Personal Details Form -->
                        <div class="max-w-md mb-8">
                            <h3 class="text-lg font-semibold text-white mb-4">Personal Details</h3>
                            <form id="profile-details-form" class="space-y-4">
                                <div>
                                    <label for="profile-full-name" class="block text-sm font-medium text-gray-300 mb-1">Full Name</label>
                                    <input type="text" id="profile-full-name" placeholder="Enter your full name"
                                           class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                                </div>
                                <div>
                                    <label for="profile-email" class="block text-sm font-medium text-gray-300 mb-1">Email (Optional)</label>
                                    <input type="email" id="profile-email" placeholder="Enter your email"
                                           class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                                </div>
                                <button type="submit" id="save-profile-button"
                                        class="w-full py-2 px-4 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg shadow-md transition duration-150">
                                    Save Details
                                </button>
                                <p id="profile-save-success" class="text-green-400 text-sm mt-3 hidden">Profile details saved!</p>
                            </form>
                        </div>
                        
                        <!-- Danger Zone for clearing data -->
                        <div class="max-w-md">
                            <h3 class="text-lg font-semibold text-red-400 mb-2">Danger Zone</h3>
                            <p class="text-gray-400 mb-4 text-sm">This action will permanently delete all trade data *from your account*. This cannot be undone.</p>
                            <button id="clear-all-data-button" class="py-2 px-5 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg shadow-md transition duration-150">
                                Clear All Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>
    
        </div> <!-- End Main App Container -->

        <!-- Footer/Info -->
        <div class="mt-8 text-xs text-center text-gray-500">
            <!-- This footer is now for the main app -->
            <div id="app-footer" class="hidden">
                <!-- CHANGED from Username to Mobile Number -->
                Logged in with: <span id="footer-user-username" class="font-mono text-yellow-400"></span>
                <div id="auth-status" class="mt-2 text-gray-500">Authenticating...</div> 
            </div>
            <div id="auth-footer">
                Please log in or sign up to continue.
            </div>
        </div>

        <!-- Modal for Custom Alert/Error -->
        <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full border border-gray-700">
                <h3 id="modal-title" class="text-xl font-bold text-white mb-4"></h3>
                <p id="modal-content" class="text-gray-300 mb-6"></p>
                <button id="modal-close" class_temp="w-full py-2 px-4 bg-yellow-600 hover:bg-yellow-500 text-gray-900 font-bold rounded-lg transition duration-150">
                    Close
                </button>
            </div>
        </div>

        <!-- Modal for Editing Trades -->
        <div id="edit-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full border border-gray-700">
                <form id="edit-trade-form">
                    <h3 id="edit-modal-title" class="text-xl font-bold text-white mb-4">Edit Rate</h3>
                    <input type="hidden" id="edit-trade-id">
                    <div class="mb-4">
                        <label for="edit-buy-amount" class="block text-sm font-medium text-green-400 mb-1">Buy Rate</label>
                        <input type="number" id="edit-buy-amount" step="any" min="0"
                               class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-green-500 focus:border-green-500 transition duration-150">
                    </div>
                    <div class="mb-6">
                        <label for="edit-sell-amount" class="block text-sm font-medium text-red-400 mb-1">Sell Rate</label>
                        <input type="number" id="edit-sell-amount" step="any" min="0"
                               class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-red-500 focus:border-red-500 transition duration-150">
                    </div>
                    <p id="edit-error-message" class="text-red-400 text-sm mb-4 hidden"></p>
                    <div class="flex space-x-4">
                        <button type="button" id="edit-cancel-button" class="w-1/2 py-2 px-4 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-lg transition duration-150">
                            Cancel
                        </button>
                        <button type="submit" id="edit-save-button" class="w-1/2 py-2 px-4 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg transition duration-150">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Modal for Delete Confirmation -->
        <div id="delete-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full border border-red-700">
                <h3 id="delete-modal-title" class="text-xl font-bold text-red-400 mb-4">Confirm Deletion</h3>
                <p id="delete-modal-content" class="text-gray-300 mb-6">Are you sure you want to delete this trade? This action cannot be undone.</p>
                <input type="hidden" id="delete-trade-id">
                <div class="flex space-x-4">
                    <button type="button" id="delete-cancel-button" class="w-1/2 py-2 px-4 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-lg transition duration-150">
                        Cancel
                    </button>
                    <button type="button" id="delete-confirm-button" class="w-1/2 py-2 px-4 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg transition duration-150">
                        Delete
                    </button>
                </div>
            </div>
        </div>

        <!-- NEW: Modal for Clear All Data Confirmation -->
        <div id="clear-data-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full border border-red-700">
                <h3 id="clear-data-modal-title" class="text-xl font-bold text-red-400 mb-4">Confirm Clear All Data</h3>
                <p id="clear-data-modal-content" class="text-gray-300 mb-6">Are you absolutely sure you want to delete ALL your trades? This action cannot be undone.</live-in>
                <div class="flex space-x-4">
                    <button type="button" id="clear-data-cancel-button" class="w-1/2 py-2 px-4 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-lg transition duration-150">
                        Cancel
                    </button>
                    <button type="button" id="clear-data-confirm-button" class="w-1/2 py-2 px-4 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg transition duration-150">
                        Yes, Delete All
                    </button>
                </div>
            </div>
        </div>

        <!-- NEW: Modal for P&L Details -->
        <div id="pl-details-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-2xl w-full border border-gray-700">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="pl-details-title" class="text-xl font-bold text-white">Profit/Loss Details</h3>
                    <button id="pl-details-close-button" class="text-gray-400 hover:text-white">&times;</button>
                </div>
                <!-- Content area for the P&L breakdown -->
                <div id="pl-details-content" class="max-h-96 overflow-y-auto text-sm text-gray-300">
                    <!-- Details will be injected here -->
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        // Firebase imports: Added Email/Password Auth and SignOut
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut,
            signInAnonymously, // Keep for placeholder
            signInWithCustomToken // Keep for env
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            addDoc, 
            onSnapshot, 
            collection, 
            query, 
            serverTimestamp, 
            setLogLevel, 
            deleteDoc, 
            updateDoc,
            writeBatch, // Added for clear all data
            getDocs, // Added for clear all data
            setDoc, // NEW: For profile
            getDoc // NEW: For profile
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config ---
        // This is your actual config object
        const firebaseConfig = {
            apiKey: "AIzaSyAYy9FONBnwilc2f3WdTCGFQ2-W3jQvE3E",
            authDomain: "parth-trading.firebaseapp.com",
            projectId: "parth-trading",
            storageBucket: "parth-trading.firebasestorage.app",
            messagingSenderId: "629101446151",
            appId: "1:629101446151:web:d91110064a8889497916a2",
            measurementId: "G-7JQ523ETHN"
        };
        
        // This is no longer used, but we keep the logic in case the env is injected
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // Firebase App variables
        let db;
        let auth;
        let userId = null;
        let username = null; // This now holds the mobile number

        // Data cache
        let allTradesData = [];
        let unsubscribeFromTrades = null; // To stop listener on sign-out

        // --- DOM Elements ---
        const modalEl = document.getElementById('custom-modal');
        const modalTitleEl = document.getElementById('modal-title');
        const modalContentEl = document.getElementById('modal-content');
        const modalCloseEl = document.getElementById('modal-close');
        
        // Page Views & Containers
        const mainAppContainerEl = document.getElementById('main-app-container');
        const authContainerEl = document.getElementById('auth-container');
        const loginViewEl = document.getElementById('login-view');
        const registerViewEl = document.getElementById('register-view');
        const dashboardViewEl = document.getElementById('dashboard-view');
        const goldViewEl = document.getElementById('gold-view');
        const silverViewEl = document.getElementById('silver-view');
        const reportViewEl = document.getElementById('report-view');
        const profileViewEl = document.getElementById('profile-view'); // Renamed
        const navLinks = document.querySelectorAll('.nav-link');
 
        // Gold Elements
        const goldTradeFormEl = document.getElementById('gold-trade-form');
        const goldSubmitButton = document.getElementById('gold-submit-button');
        const goldErrorMessageEl = document.getElementById('gold-error-message');
        const goldLoadingMessageEl = document.getElementById('gold-loading-message');
        const goldTradesBodyEl = document.getElementById('gold-trades-body');
        
        // Silver Elements
        const silverTradeFormEl = document.getElementById('silver-trade-form');
        const silverSubmitButton = document.getElementById('silver-submit-button');
        const silverErrorMessageEl = document.getElementById('silver-error-message');
        const silverLoadingMessageEl = document.getElementById('silver-loading-message');
        const silverTradesBodyEl = document.getElementById('silver-trades-body');

        // Dashboard Elements
        const goldAvgBuyEl = document.getElementById('gold-avg-buy');
        const goldAvgSellEl = document.getElementById('gold-avg-sell');
        const goldTradeCountEl = document.getElementById('gold-trade-count');
        const silverAvgBuyEl = document.getElementById('silver-avg-buy');
        const silverAvgSellEl = document.getElementById('silver-avg-sell');
        const silverTradeCountEl = document.getElementById('silver-trade-count');

        // Report Elements
        // REMOVED old solo elements
        const reportOverallViewEl = document.getElementById('report-overall-view');
        const reportGoldViewEl = document.getElementById('report-gold-view');
        const reportSilverViewEl = document.getElementById('report-silver-view');
        const reportNavLinks = document.querySelectorAll('.report-nav-link');

        // NEW: Gold Report Table Elements
        const goldAvgBuyReportEl = document.getElementById('gold-avg-buy-report');
        const goldTotalBuyReportEl = document.getElementById('gold-total-buy-report');
        const goldAvgSellReportEl = document.getElementById('gold-avg-sell-report');
        const goldTotalSellReportEl = document.getElementById('gold-total-sell-report');
        const goldPlReportEl = document.getElementById('gold-pl-report');

        // NEW: Silver Report Table Elements
        const silverAvgBuyReportEl = document.getElementById('silver-avg-buy-report');
        const silverTotalBuyReportEl = document.getElementById('silver-total-buy-report');
        const silverAvgSellReportEl = document.getElementById('silver-avg-sell-report');
        const silverTotalSellReportEl = document.getElementById('silver-total-sell-report');
        const silverPlReportEl = document.getElementById('silver-pl-report');

        // NEW: P&L Report Elements
        const plReportBodyEl = document.getElementById('pl-report-body');
        // REMOVED duplicate total elements - they are created in JS
        const plReportLoadingEl = document.getElementById('pl-report-loading');
 
        // Edit Modal Elements
        const editModalEl = document.getElementById('edit-modal');
        const editModalTitleEl = document.getElementById('edit-modal-title');
        const editTradeFormEl = document.getElementById('edit-trade-form');
        const editTradeIdEl = document.getElementById('edit-trade-id');
        const editBuyAmountEl = document.getElementById('edit-buy-amount');
        const editSellAmountEl = document.getElementById('edit-sell-amount');
        const editErrorMessageEl = document.getElementById('edit-error-message');
        const editCancelButtonEl = document.getElementById('edit-cancel-button');
        
        // Delete Modal Elements
        const deleteModalEl = document.getElementById('delete-modal');
        const deleteTradeIdEl = document.getElementById('delete-trade-id');
        const deleteCancelButtonEl = document.getElementById('delete-cancel-button');
        const deleteConfirmButtonEl = document.getElementById('delete-confirm-button');

        // Clear Data Modal Elements
        const clearAllDataButtonEl = document.getElementById('clear-all-data-button');
        const clearDataModalEl = document.getElementById('clear-data-modal');
        const clearDataCancelButtonEl = document.getElementById('clear-data-cancel-button');
        const clearDataConfirmButtonEl = document.getElementById('clear-data-confirm-button');

        // NEW: P&L Details Modal Elements
        const plDetailsModalEl = document.getElementById('pl-details-modal');
        const plDetailsTitleEl = document.getElementById('pl-details-title');
        const plDetailsContentEl = document.getElementById('pl-details-content');
        const plDetailsCloseButtonEl = document.getElementById('pl-details-close-button');

        // Profile & Auth Elements
        const loginFormEl = document.getElementById('login-form');
        const registerFormEl = document.getElementById('register-form');
        const loginErrorEl = document.getElementById('login-error');
        const registerErrorEl = document.getElementById('register-error');
        const gotoRegisterLinkEl = document.getElementById('goto-register-link');
        const gotoLoginLinkEl = document.getElementById('goto-login-link');
        const userUsernameDisplayEl = document.getElementById('user-username-display'); // CHANGED (now holds number)
        const signOutButtonEl = document.getElementById('sign-out-button');
        const authStatusEl = document.getElementById('auth-status');
        const appFooterEl = document.getElementById('app-footer');
        const authFooterEl = document.getElementById('auth-footer');
        const footerUserUsernameEl = document.getElementById('footer-user-username'); // CHANGED (now holds number)

        // NEW: Gemini Insights Elements
        const insightsButton = document.getElementById('get-market-insights-button');
        const insightsLoading = document.getElementById('insights-loading');
        const insightsContent = document.getElementById('insights-content');
        const insightsSources = document.getElementById('insights-sources');

        // NEW: Profile Details Elements
        const profileDetailsFormEl = document.getElementById('profile-details-form');
        const profileFullNameEl = document.getElementById('profile-full-name');
        const profileEmailEl = document.getElementById('profile-email');
        const saveProfileButtonEl = document.getElementById('save-profile-button');
        const profileSaveSuccessEl = document.getElementById('profile-save-success');


        // --- Utility Functions ---
        
        // This is the (hidden) domain we'll add to usernames to make them "emails"
        const FAKE_DOMAIN = "@trade-tracker.app";
        // FIX: Add a prefix to make the email valid for sign-in
        const PHONE_PREFIX = "phone-";

        /**
         * Refreshes all UI components (tables, dashboard) from 'allTradesData'.
         */
        const updateAllUI = () => {
            allTradesData.sort((a, b) => {
                const dateA = a.timestamp?.toDate ? a.timestamp.toDate() : new Date(a.timestamp || 0);
                const dateB = b.timestamp?.toDate ? b.timestamp.toDate() : new Date(b.timestamp || 0);
                return dateA - dateB;
            });
            
            // This function calculates "Net Position" (Total Buys vs Sells)
            // It is used for the Dashboard and the "Net Position" report pages
            updateNetPositionReport(allTradesData); 
            // NEW: This function calculates "Realized P&L" (FIFO)
            // It is used for the "Overall P&L" report page
            updateRealizedPLReport(allTradesData);

            renderHistoryTable('gold', goldTradesBodyEl, goldLoadingMessageEl);
            renderHistoryTable('silver', silverTradesBodyEl, silverLoadingMessageEl);
        };

        const formatDate = (timestamp) => {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' }).replace(/\//g, '/');
        };

        const toStorageDate = (date) => {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        };

        const showModal = (title, content) => {
            if (!modalTitleEl || !modalContentEl || !modalEl) return;
            modalTitleEl.textContent = title;
            modalContentEl.textContent = content;
            modalEl.classList.remove('hidden');
            modalEl.classList.add('flex');
        };

        if(modalCloseEl) modalCloseEl.addEventListener('click', () => {
            modalEl.classList.add('hidden');
            modalEl.classList.remove('flex');
        });
        
        const getMondayOfWeek = (dateInput) => {
            let d;
            if (!dateInput) {
                d = new Date();
            } else {
                d = dateInput.toDate ? dateInput.toDate() : new Date(dateInput);
            }
            d.setHours(0, 0, 0, 0);
            let day = d.getDay(); 
            let daysToSubtract = day === 0 ? 6 : day - 1;
            d.setDate(d.getDate() - daysToSubtract);
            return toStorageDate(d);
        };

        // --- NEW: Gemini API Functions ---

        // Function to handle exponential backoff
        const sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

        /**
         * Calls the Gemini API with exponential backoff.
         * @param {string} prompt The user prompt to send.
         * @param {boolean} useGrounding Whether to enable Google Search grounding.
         */
        async function callGeminiApi(prompt, useGrounding = false) {
            // !! IMPORTANT !!
            // This placeholder API key MUST be replaced with your actual Gemini API key
            // or populated by the environment.
            const apiKey = ""; // <--- YOU MUST ADD YOUR GEMINI API KEY HERE
            
            if (apiKey === "") {
                console.warn("Gemini API Key is missing. Market Insights feature is disabled.");
                // Return a user-friendly error instead of throwing, so the app doesn't break
                return { 
                    text: "Market Insights feature is disabled. A Gemini API key is required.", 
                    sources: [] 
                };
            }
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            if (useGrounding) payload.tools = [{ "google_search": {} }];

            let response;
            let retries = 5;
            let delay = 1000; 

            for (let i = 0; i < retries; i++) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const candidate = result.candidates?.[0];
                        if (candidate && candidate.content?.parts?.[0]?.text) {
                            const text = candidate.content.parts[0].text;
                            let sources = [];
                            const groundingMetadata = candidate.groundingMetadata;
                            if (useGrounding && groundingMetadata && groundingMetadata.groundingAttributions) {
                                sources = groundingMetadata.groundingAttributions
                                    .map(attribution => ({
                                        uri: attribution.web?.uri,
                                        title: attribution.web?.title,
                                    }))
                                    .filter(source => source.uri && source.title);
                            }
                            return { text, sources };
                        } else {
                            throw new Error("API returned no content.");
                        }
                    } else if (response.status === 429 || response.status >= 500) {
                        if (i === retries - 1) throw new Error(`API request failed after ${retries} attempts with status: ${response.status}`);
                        await sleep(delay);
                        delay *= 2;
                    } else {
                        const errorResult = await response.json();
                        if (response.status === 403) {
                             throw new Error(`API key is invalid or not authorized (Error 403).`);
                        }
                        throw new Error(`API request failed: ${errorResult.error?.message || response.statusText}`);
                    }
                } catch (error) {
                    console.error("Fetch error:", error);
                    if (i === retries - 1) throw error; 
                    await sleep(delay);
                    delay *= 2;
                }
            }
            throw new Error("Failed to get response from API after all retries.");
        }


        // --- UI Rendering Functions ---

        const openDeleteModal = (tradeId) => {
            deleteTradeIdEl.value = tradeId;
            deleteModalEl.classList.remove('hidden');
            deleteModalEl.classList.add('flex');
        };

        const openEditModal = ({ id, commodity, buy, sell }) => {
            editTradeIdEl.value = id;
            editBuyAmountEl.value = buy;
            editSellAmountEl.value = sell;
            editModalTitleEl.textContent = `Edit ${commodity} Rate`;
            editErrorMessageEl.classList.add('hidden');
            editModalEl.classList.remove('hidden');
            editModalEl.classList.add('flex');
        };

        const handleTableAction = (e) => {
            const target = e.target.closest('button');
            if (!target) return;
            const tradeId = target.dataset.id;
            if (!tradeId) return;
            if (target.classList.contains('delete-trade-btn')) {
                openDeleteModal(tradeId);
            } else if (target.classList.contains('edit-trade-btn')) {
                const { id, commodity, buy, sell } = target.dataset;
                openEditModal({ id, commodity, buy, sell });
            }
        };

        const renderHistoryTable = (commodity, tableBodyEl, loadingEl) => {
            const filteredTrades = allTradesData.filter(t => t.commodity === commodity);
            tableBodyEl.innerHTML = ''; 
            if (filteredTrades.length === 0) {
                tableBodyEl.innerHTML = `<tr><td colspan="5" class="px-3 py-4 whitespace-nowrap text-center text-sm text-gray-400">No ${commodity} trades recorded yet.</td></tr>`;
                loadingEl.style.display = 'none';
                return;
            }
            let currentWeekNumber = 0;
            const weekMap = {}; 
            // Sort by date to get week numbers correct
            const sortedTrades = [...filteredTrades].sort((a, b) => {
                const dateA = a.timestamp?.toDate ? a.timestamp.toDate() : new Date(a.timestamp || 0);
                const dateB = b.timestamp?.toDate ? b.timestamp.toDate() : new Date(b.timestamp || 0);
                return dateA - dateB;
            });

            sortedTrades.forEach((trade) => {
                const mondayDateString = getMondayOfWeek(trade.timestamp);
                let weekToDisplay;
                if (weekMap[mondayDateString] === undefined) {
                    currentWeekNumber++;
                    weekMap[mondayDateString] = currentWeekNumber;
                }
                weekToDisplay = weekMap[mondayDateString];
                
                // We will build the row and insert it. This is more robust.
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-700 transition duration-150';

                const buyAmount = trade.buyAmount || 0;
                const sellAmount = trade.sellAmount || 0;

                row.innerHTML = `
                    <td><div class="px-3 py-4 whitespace-nowrap text-sm font-medium ${commodity === 'gold' ? 'text-yellow-400' : 'text-gray-300'}">${weekToDisplay}</div></td>
                    <td><div class="px-3 py-4 whitespace-nowrap text-sm text-gray-300">${trade.date || formatDate(trade.timestamp)}</div></td>
                    <td><div class="px-3 py-4 whitespace-nowrap text-sm font-semibold ${buyAmount > 0 ? 'text-green-400' : 'text-gray-500'}">${parseFloat(buyAmount).toFixed(2)}</div></td>
                    <td><div class="px-3 py-4 whitespace-nowrap text-sm font-semibold ${sellAmount > 0 ? 'text-red-400' : 'text-gray-500'}">${parseFloat(sellAmount).toFixed(2)}</div></td>
                    <td>
                        <div class="px-3 py-4 whitespace-nowrap text-sm text-center flex items-center justify-start space-x-2">
                            <button class="edit-trade-btn px-2 py-1 bg-blue-600 text-white text-xs font-semibold rounded-md hover:bg-blue-500 transition duration-150" 
                                    data-id="${trade.id}" 
                                    data-commodity="${trade.commodity}"
                                    data-buy="${buyAmount}"
                                    data-sell="${sellAmount}">
                                Edit
                            </button>
                            <button class="delete-trade-btn px-2 py-1 bg-red-600 text-white text-xs font-semibold rounded-md hover:bg-red-500 transition duration-150" 
                                    data-id="${trade.id}">
                                Delete
                            </button>
                        </div>
                    </td>
                `;
                tableBodyEl.appendChild(row);
            });
            loadingEl.style.display = 'none';
        };

        const updateNetPositionUI = (element, netPosition, commodity) => {
            if (!element) return;
            element.textContent = netPosition.toFixed(2);
            element.classList.remove('text-green-400', 'text-red-400', 'text-gray-300', 'text-yellow-400', 'text-white');
            if (netPosition > 0) element.classList.add('text-green-400');
            else if (netPosition < 0) element.classList.add('text-red-400');
            else {
                if (commodity === 'Gold') element.classList.add('text-yellow-400');
                else if (commodity === 'Silver') element.classList.add('text-gray-300');
                else element.classList.add('text-white');
            }
        };

        /**
         * This function calculates and displays the NET POSITION report
         * (Total Buys - Total Sells)
         */
        const updateNetPositionReport = (trades) => {
            // This logic is unchanged, just moved into a function
            const goldTrades = trades.filter(t => t.commodity === 'gold');
            const silverTrades = trades.filter(t => t.commodity === 'silver');
            const currentMonday = getMondayOfWeek(new Date());

            // --- Process Gold ---
            let goldTotalBuy_AllTime = 0, goldTotalSell_AllTime = 0;
            let goldBuyTradeCount_AllTime = 0, goldSellTradeCount_AllTime = 0;
            goldTrades.forEach(trade => {
                const buyAmt = trade.buyAmount || 0;
                const sellAmt = trade.sellAmount || 0;
                if (buyAmt > 0) {
                    goldTotalBuy_AllTime += buyAmt;
                    goldBuyTradeCount_AllTime++;
                }
                if (sellAmt > 0) {
                    goldTotalSell_AllTime += sellAmt;
                    goldSellTradeCount_AllTime++;
                }
            });
            
            // --- Process Gold (Current Week) ---
            let goldTotalBuy_CurrentWeek = 0, goldTotalSell_CurrentWeek = 0;
            let goldBuyTradeCount_CurrentWeek = 0, goldSellTradeCount_CurrentWeek = 0, goldTotalTradeCount_CurrentWeek = 0; 
            goldTrades.forEach(trade => {
                if (getMondayOfWeek(trade.timestamp) === currentMonday) {
                    goldTotalTradeCount_CurrentWeek++; 
                    const buyAmt = trade.buyAmount || 0;
                    const sellAmt = trade.sellAmount || 0;
                    if (buyAmt > 0) { goldTotalBuy_CurrentWeek += buyAmt; goldBuyTradeCount_CurrentWeek++; }
                    if (sellAmt > 0) { goldTotalSell_CurrentWeek += sellAmt; goldSellTradeCount_CurrentWeek++; }
                }
            });
            const goldAvgBuy_CurrentWeek = goldBuyTradeCount_CurrentWeek > 0 ? (goldTotalBuy_CurrentWeek / goldBuyTradeCount_CurrentWeek) : 0;
            const goldAvgSell_CurrentWeek = goldSellTradeCount_CurrentWeek > 0 ? (goldTotalSell_CurrentWeek / goldSellTradeCount_CurrentWeek) : 0;
            if(goldAvgBuyEl) goldAvgBuyEl.textContent = goldAvgBuy_CurrentWeek.toFixed(2);
            if(goldAvgSellEl) goldAvgSellEl.textContent = goldAvgSell_CurrentWeek.toFixed(2);
            if(goldTradeCountEl) goldTradeCountEl.textContent = `Based on ${goldTotalTradeCount_CurrentWeek} trades this week.`;
            
            // --- NEW: Update Gold Report Table ---
            const goldAvgBuy_AllTime = goldBuyTradeCount_AllTime > 0 ? (goldTotalBuy_AllTime / goldBuyTradeCount_AllTime) : 0;
            const goldAvgSell_AllTime = goldSellTradeCount_AllTime > 0 ? (goldTotalSell_AllTime / goldSellTradeCount_AllTime) : 0;
            const goldPL_AllTime = calculateFifoPL(goldTrades, 'gold'); // Use P&L function
            
            if (goldAvgBuyReportEl) goldAvgBuyReportEl.textContent = goldAvgBuy_AllTime.toFixed(2);
            if (goldTotalBuyReportEl) goldTotalBuyReportEl.textContent = goldTotalBuy_AllTime.toFixed(2);
            if (goldAvgSellReportEl) goldAvgSellReportEl.textContent = goldAvgSell_AllTime.toFixed(2);
            if (goldTotalSellReportEl) goldTotalSellReportEl.textContent = goldTotalSell_AllTime.toFixed(2);
            if (goldPlReportEl) {
                goldPlReportEl.textContent = goldPL_AllTime.totalPL.toFixed(2);
                goldPlReportEl.classList.toggle('text-green-400', goldPL_AllTime.totalPL > 0);
                goldPlReportEl.classList.toggle('text-red-400', goldPL_AllTime.totalPL < 0);
                goldPlReportEl.classList.toggle('text-white', goldPL_AllTime.totalPL === 0);
            }

            // --- Process Silver ---
            let silverTotalBuy_AllTime = 0, silverTotalSell_AllTime = 0;
            let silverBuyTradeCount_AllTime = 0, silverSellTradeCount_AllTime = 0;
            silverTrades.forEach(trade => {
                const buyAmt = trade.buyAmount || 0;
                const sellAmt = trade.sellAmount || 0;
                if (buyAmt > 0) {
                    silverTotalBuy_AllTime += buyAmt;
                    silverBuyTradeCount_AllTime++;
                }
                if (sellAmt > 0) {
                    silverTotalSell_AllTime += sellAmt;
                    silverSellTradeCount_AllTime++;
                }
            });

            // --- Process Silver (Current Week) ---
            let silverTotalBuy_CurrentWeek = 0, silverTotalSell_CurrentWeek = 0;
            let silverBuyTradeCount_CurrentWeek = 0, silverSellTradeCount_CurrentWeek = 0, silverTotalTradeCount_CurrentWeek = 0;
            silverTrades.forEach(trade => {
                if (getMondayOfWeek(trade.timestamp) === currentMonday) {
                    silverTotalTradeCount_CurrentWeek++; 
                    const buyAmt = trade.buyAmount || 0;
                    const sellAmt = trade.sellAmount || 0;
                    if (buyAmt > 0) { silverTotalBuy_CurrentWeek += buyAmt; silverBuyTradeCount_CurrentWeek++; }
                    if (sellAmt > 0) { silverTotalSell_CurrentWeek += sellAmt; silverSellTradeCount_CurrentWeek++; }
                }
            });
            const silverAvgBuy_CurrentWeek = silverBuyTradeCount_CurrentWeek > 0 ? (silverTotalBuy_CurrentWeek / silverBuyTradeCount_CurrentWeek) : 0;
            const silverAvgSell_CurrentWeek = silverSellTradeCount_CurrentWeek > 0 ? (silverTotalSell_CurrentWeek / silverSellTradeCount_CurrentWeek) : 0;
            if(silverAvgBuyEl) silverAvgBuyEl.textContent = silverAvgBuy_CurrentWeek.toFixed(2);
            if(silverAvgSellEl) silverAvgSellEl.textContent = silverAvgSell_CurrentWeek.toFixed(2);
            if(silverTradeCountEl) silverTradeCountEl.textContent = `Based on ${silverTotalTradeCount_CurrentWeek} trades this week.`;

            // --- NEW: Update Silver Report Table ---
            const silverAvgBuy_AllTime = silverBuyTradeCount_AllTime > 0 ? (silverTotalBuy_AllTime / silverBuyTradeCount_AllTime) : 0;
            const silverAvgSell_AllTime = silverSellTradeCount_AllTime > 0 ? (silverTotalSell_AllTime / silverSellTradeCount_AllTime) : 0;
            const silverPL_AllTime = calculateFifoPL(silverTrades, 'silver'); // Use P&L function
            
            if (silverAvgBuyReportEl) silverAvgBuyReportEl.textContent = silverAvgBuy_AllTime.toFixed(2);
            if (silverTotalBuyReportEl) silverTotalBuyReportEl.textContent = silverTotalBuy_AllTime.toFixed(2);
            if (silverAvgSellReportEl) silverAvgSellReportEl.textContent = silverAvgSell_AllTime.toFixed(2);
            if (silverTotalSellReportEl) silverTotalSellReportEl.textContent = silverTotalSell_AllTime.toFixed(2);
            if (silverPlReportEl) {
                silverPlReportEl.textContent = silverPL_AllTime.totalPL.toFixed(2);
                silverPlReportEl.classList.toggle('text-green-400', silverPL_AllTime.totalPL > 0);
                silverPlReportEl.classList.toggle('text-red-400', silverPL_AllTime.totalPL < 0);
                silverPlReportEl.classList.toggle('text-white', silverPL_AllTime.totalPL === 0);
            }

        };
 
        // --- NEW: FIFO P&L Calculation Logic ---

        /**
         * This function calculates and displays the REALIZED P&L report
         * using FIFO (First-In, First-Out) logic.
         */
        const updateRealizedPLReport = (trades) => {
            if (!plReportBodyEl) return; // Don't run if element doesn't exist

            plReportBodyEl.innerHTML = ''; // Clear old rows
            if(plReportLoadingEl) plReportLoadingEl.style.display = 'block';

            // Group trades by week
            const weeklyData = {};
            const weekMap = {};
            let weekCounter = 0;

            trades.forEach(trade => {
                const monday = getMondayOfWeek(trade.timestamp);
                let weekNum;
                if (weekMap[monday] === undefined) {
                    weekCounter++;
                    weekMap[monday] = weekCounter;
                }
                weekNum = weekMap[monday];

                if (!weeklyData[weekNum]) {
                    weeklyData[weekNum] = { gold: [], silver: [] };
                }
                
                if (trade.commodity === 'gold') weeklyData[weekNum].gold.push(trade);
                else if (trade.commodity === 'silver') weeklyData[weekNum].silver.push(trade);
            });

            let totalGoldPL = 0;
            let totalSilverPL = 0;

            // Calculate P&L for each week
            const weekKeys = Object.keys(weeklyData).sort((a, b) => a - b);
            
            weekKeys.forEach(weekNum => {
                const goldTrades = weeklyData[weekNum].gold;
                const silverTrades = weeklyData[weekNum].silver;

                const goldPLResult = calculateFifoPL(goldTrades, 'gold');
                const silverPLResult = calculateFifoPL(silverTrades, 'silver');
                const totalPL = goldPLResult.totalPL + silverPLResult.totalPL;

                totalGoldPL += goldPLResult.totalPL;
                totalSilverPL += silverPLResult.totalPL;

                const row = plReportBodyEl.insertRow();
                row.className = 'hover:bg-gray-700 transition duration-150';
                // UPDATED: Added data-attributes and classes for clickability
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-semibold text-yellow-400">Week ${weekNum}</td>
                    <td class="pl-details-button px-4 py-3 whitespace-nowrap text-sm font-medium cursor-pointer hover:underline ${goldPLResult.totalPL > 0 ? 'text-green-400' : (goldPLResult.totalPL < 0 ? 'text-red-400' : 'text-gray-400')}"
                        data-commodity="gold" data-week="${weekNum}" title="Click to see details">
                        ${goldPLResult.totalPL.toFixed(2)}
                    </td>
                    <td class="pl-details-button px-4 py-3 whitespace-nowrap text-sm font-medium cursor-pointer hover:underline ${silverPLResult.totalPL > 0 ? 'text-green-400' : (silverPLResult.totalPL < 0 ? 'text-red-400' : 'text-gray-400')}"
                        data-commodity="silver" data-week="${weekNum}" title="Click to see details">
                        ${silverPLResult.totalPL.toFixed(2)}
                    </td>
                    <td class="pl-details-button px-4 py-3 whitespace-nowrap text-right text-sm font-medium cursor-pointer hover:underline ${totalPL > 0 ? 'text-green-400' : (totalPL < 0 ? 'text-red-400' : 'text-gray-400')}"
                        data-commodity="all" data-week="${weekNum}" title="Click to see details">
                        ${totalPL.toFixed(2)}
                    </td>
                `;
            });

            // Update Total Row
            const totalAllPL = totalGoldPL + totalSilverPL;
            
            const totalRow = plReportBodyEl.insertRow(); // Add total row at the end
            totalRow.className = 'bg-gray-700 font-bold';
            // UPDATED: Added data-attributes and classes for clickability
            totalRow.innerHTML = `
                <td class="px-4 py-4 whitespace-nowrap text-sm font-extrabold text-white">Total</td>
                <td id="pl-total-gold" class="pl-details-button px-4 py-4 whitespace-nowrap text-sm font-extrabold cursor-pointer hover:underline ${totalGoldPL > 0 ? 'text-green-400' : (totalGoldPL < 0 ? 'text-red-400' : 'text-white')}"
                    data-commodity="gold" data-week="all" title="Click to see details">
                    ${totalGoldPL.toFixed(2)}
                </td>
                <td id="pl-total-silver" class="pl-details-button px-4 py-4 whitespace-nowrap text-sm font-extrabold cursor-pointer hover:underline ${totalSilverPL > 0 ? 'text-green-400' : (totalSilverPL < 0 ? 'text-red-400' : 'text-white')}"
                    data-commodity="silver" data-week="all" title="Click to see details">
                    ${totalSilverPL.toFixed(2)}
                </td>
                <td id="pl-total-all" class="pl-details-button px-4 py-4 whitespace-nowrap text-right text-sm font-extrabold cursor-pointer hover:underline ${totalAllPL > 0 ? 'text-green-400' : (totalAllPL < 0 ? 'text-red-400' : 'text-white')}"
                    data-commodity="all" data-week="all" title="Click to see details">
                    ${totalAllPL.toFixed(2)}
                </td>
            `;

            if(plReportLoadingEl) plReportLoadingEl.style.display = 'none';
        };

        /**
         * Calculates P&L for a set of trades using FIFO logic.
         * UPDATED: Now returns a detailed object with all pairs.
         */
        function calculateFifoPL(trades, commodity) {
            let realizedPL = 0;
            let pairs = [];
            let totalProfit = 0;
            let totalCommission = 0;

            let longPositions = []; // Queue of buys: { price: number }
            let shortPositions = []; // Queue of sells: { price: number }

            // Define constants based on commodity
            const commission = 300;
            const multiplier = (commodity === 'gold') ? 10 : 5; // 10 for Gold (100g/10g), 5 for Silver (5kg/1kg)

            // Sort trades by timestamp to ensure correct order
            const sortedTrades = [...trades].sort((a, b) => {
                const dateA = a.timestamp?.toDate ? a.timestamp.toDate() : new Date(a.timestamp || 0);
                const dateB = b.timestamp?.toDate ? b.timestamp.toDate() : new Date(b.timestamp || 0);
                return dateA - dateB;
            });

            for (const trade of sortedTrades) {
                const buyPrice = trade.buyAmount || 0;   // This is the rate
                const sellPrice = trade.sellAmount || 0; // This is the rate

                if (buyPrice > 0) {
                    // This is a BUY transaction
                    if (shortPositions.length > 0) {
                        // Close an existing short position
                        const openingShortRate = shortPositions.shift().price;
                        const profit = (openingShortRate - buyPrice) * multiplier;
                        const netProfit = profit - commission;
                        realizedPL += netProfit;
                        
                        // Store details
                        totalProfit += profit;
                        totalCommission += commission;
                        pairs.push({ buy: buyPrice, sell: openingShortRate, profit: profit, commission: commission, net: netProfit });
                    } else {
                        // Open a new long position
                        longPositions.push({ price: buyPrice });
                    }
                } else if (sellPrice > 0) {
                    // This is a SELL transaction
                    if (longPositions.length > 0) {
                        // Close an existing long position
                        const openingLongRate = longPositions.shift().price;
                        const profit = (sellPrice - openingLongRate) * multiplier;
                        const netProfit = profit - commission;
                        realizedPL += netProfit;

                        // Store details
                        totalProfit += profit;
                        totalCommission += commission;
                        pairs.push({ buy: openingLongRate, sell: sellPrice, profit: profit, commission: commission, net: netProfit });
                    } else {
                        // Open a new short position
                        shortPositions.push({ price: sellPrice });
                    }
                }
            }
            
            // Return the detailed object
            return {
                totalPL: realizedPL,
                pairs: pairs,
                pairCount: pairs.length,
                totalProfit: totalProfit,
                totalCommission: totalCommission
            };
        }


        // --- Page Routing ---
        
        const showReportSubView = (hash) => {
            if (hash === '#report') hash = '#report-overall';
            const viewMap = {
                '#report-overall': reportOverallViewEl,
                '#report-gold': reportGoldViewEl,
                '#report-silver': reportSilverViewEl
            };
            Object.values(viewMap).forEach(el => { if(el) el.style.display = 'none'; });
            reportNavLinks.forEach(link => {
                link.classList.remove('bg-green-600', 'text-white', 'hover:bg-green-500');
                link.classList.add('text-gray-300', 'hover:bg-gray-700');
            });
            const targetEl = viewMap[hash];
            if (targetEl) {
                targetEl.style.display = 'block';
                const activeLink = document.querySelector(`.report-nav-link[href="${hash}"]`);
                if(activeLink) {
                    activeLink.classList.remove('text-gray-300', 'hover:bg-gray-700');
                    activeLink.classList.add('bg-green-600', 'text-white', 'hover:bg-green-500');
                }
            } else {
                if(reportOverallViewEl) reportOverallViewEl.style.display = 'block';
                const activeLink = document.querySelector('.report-nav-link[href="#report-overall"]');
                if(activeLink) {
                    activeLink.classList.remove('text-gray-300', 'hover:bg-gray-700');
                    activeLink.classList.add('bg-green-600', 'text-white', 'hover:bg-green-500');
                }
            }
        };
 
        // This shows pages *within* the main app
        const showAppView = (hash) => {
            const viewMap = {
                '#dashboard': dashboardViewEl,
                '#gold': goldViewEl,
                '#silver': silverViewEl,
                '#report': reportViewEl,
                '#profile': profileViewEl
            };

            Object.values(viewMap).forEach(el => { if(el) el.style.display = 'none' });
            navLinks.forEach(link => {
                link.classList.remove('bg-yellow-600', 'bg-blue-600', 'bg-green-600', 'text-gray-900', 'text-white');
                link.classList.add('text-gray-300');
            });

            const targetEl = viewMap[hash];
            if (targetEl) {
                targetEl.style.display = 'block';
                const activeLink = document.querySelector(`.nav-link[href="${hash}"]`);
                if (activeLink) {
                    activeLink.classList.remove('text-gray-300');
                    if (hash === '#gold') activeLink.classList.add('bg-yellow-600', 'text-gray-900', 'hover:bg-yellow-500');
                    else if (hash === '#silver') activeLink.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-500');
                    else if (hash === '#report') activeLink.classList.add('bg-green-600', 'text-white', 'hover:bg-green-500');
                    else if (hash === '#profile') activeLink.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-500');
                    else activeLink.classList.add('bg-yellow-600', 'text-gray-900', 'hover:bg-yellow-500');
                }
            } else {
                window.location.hash = '#dashboard'; // Default to dashboard if logged in
            }
        };

        // This shows the Login or Register pages
        const showAuthView = (hash) => {
            if (hash === '#register') {
                if(loginViewEl) loginViewEl.style.display = 'none';
                if(registerViewEl) registerViewEl.style.display = 'block';
            } else {
                if(loginViewEl) loginViewEl.style.display = 'block';
                if(registerViewEl) registerViewEl.style.display = 'none';
            }
        };

        const handleHashChange = () => {
            let hash = window.location.hash || '#login';
            
            if (auth && auth.currentUser) { // User is LOGGED IN
                if (hash === '#login' || hash === '#register') {
                    window.location.hash = '#dashboard'; // Redirect to app
                    return;
                }
                if (hash.startsWith('#report')) {
                    showAppView('#report'); 
                    showReportSubView(hash);
                } else {
                    showAppView(hash); // Show app page
                }
            } else { // User is LOGGED OUT
                if (hash === '#login' || hash === '#register') {
                    showAuthView(hash); // Show auth page
                } else {
                    window.location.hash = '#login'; // Redirect to login
                }
            }
        };
 
        window.addEventListener('hashchange', handleHashChange);
        
        // --- Firebase Service (No longer needs to be an object) ---

        const getTradesCollectionPath = () => {
            if (!userId) {
                console.error("User ID is not available.");
                return null;
            }
            return `artifacts/${appId}/users/${userId}/commodity_trades`;
        };

        // NEW: Profile Doc Ref
        const getUserProfileDocRef = () => {
            if (!userId) return null;
            return doc(db, 'artifacts', appId, 'user_profiles', userId);
        }

        const listenForTrades = () => {
            if (unsubscribeFromTrades) unsubscribeFromTrades(); // Stop old listener
            const path = getTradesCollectionPath();
            if (!path) return;
            const q = query(collection(db, path));
            unsubscribeFromTrades = onSnapshot(q, (querySnapshot) => {
                const trades = [];
                querySnapshot.forEach((doc) => {
                    trades.push({ id: doc.id, ...doc.data() });
                });
                allTradesData = trades;
                updateAllUI();
            }, (error) => {
                console.error("Error listening to trades:", error);
                showModal("Real-time Error", "Failed to load real-time trade data.");
            });
        };

        // NEW: Load Profile Details
        const loadProfileDetails = async () => {
            if (!userId) return;
            const docRef = getUserProfileDocRef();
            if (!docRef) return;
 
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if(profileFullNameEl) profileFullNameEl.value = data.fullName || '';
                    if(profileEmailEl) profileEmailEl.value = data.email || '';
                } else {
                    // No profile doc yet, clear fields
                    if(profileFullNameEl) profileFullNameEl.value = '';
                    if(profileEmailEl) profileEmailEl.value = '';
                }
            } catch (error) {
                console.error("Error loading profile details:", error);
                showModal("Error", "Could not load profile details.");
            }
        };

        // NEW: Save Profile Details
        const saveProfileDetails = async () => {
            if (!userId || !profileFullNameEl || !profileEmailEl || !profileSaveSuccessEl) return;

            const details = { 
                fullName: profileFullNameEl.value, 
                email: profileEmailEl.value 
            };
            const docRef = getUserProfileDocRef();
            if (!docRef) return;

            try {
                // Use setDoc with merge:true, it acts as create or update
                await setDoc(docRef, details, { merge: true }); 
                profileSaveSuccessEl.classList.remove('hidden');
                setTimeout(() => profileSaveSuccessEl.classList.add('hidden'), 3000);
            } catch (error) {
                console.error("Error saving profile:", error);
                showModal("Error", "Could not save profile details.");
            }
        };


        const saveTrade = async (tradeData, commodity) => {
            if (!db || !userId) {
                showModal("Error", "Database not ready or user not authenticated.");
                return;
            }
            const path = getTradesCollectionPath();
            if (!path) return;
            try {
                await addDoc(collection(db, path), {
                    ...tradeData,
                    commodity: commodity,
                    timestamp: serverTimestamp(), 
                    date: toStorageDate(new Date()), 
                });
                if(commodity === 'gold') goldTradeFormEl.reset();
                else silverTradeFormEl.reset();
                window.location.hash = '#dashboard';
            } catch (e) {
                console.error("Error adding document: ", e);
                showModal("Save Error", "Failed to save the trade entry.");
            }
        };

        const deleteTrade = async (tradeId) => {
            if (!db || !userId || !tradeId) {
                showModal("Error", "Database not ready or trade ID missing.");
                return;
            }
            const tradeDocRef = doc(db, getTradesCollectionPath(), tradeId);
            try {
                await deleteDoc(tradeDocRef);
                deleteModalEl.classList.add('hidden');
                deleteModalEl.classList.remove('flex');
            } catch (error) {
                console.error("Error deleting trade: ", error);
                showModal("Delete Error", "Could not delete the trade.");
            }
        };

        const updateTrade = async (tradeId, newData) => {
            if (!db || !userId) {
                showModal("Error", "Database not ready.");
                return;
            }
            const tradeDocRef = doc(db, getTradesCollectionPath(), tradeId);
            try {
                await updateDoc(tradeDocRef, newData);
                editModalEl.classList.add('hidden');
                editModalEl.classList.remove('flex');
            } catch (error) {
                console.error("Error updating trade: ", error);
                editErrorMessageEl.textContent = "Could not save changes.";
                editErrorMessageEl.classList.remove('hidden');
            }
        };

        const clearAllData = async () => {
            if (!db || !userId) {
                showModal("Error", "Database not ready.");
                return;
            }
            try {
                const path = getTradesCollectionPath();
                const q = query(collection(db, path));
                const querySnapshot = await getDocs(q); // Use getDocs for one-time read
                
                const batch = writeBatch(db);
                querySnapshot.forEach((doc) => {
                    batch.delete(doc.ref);
                });
                await batch.commit();

                // onSnapshot will automatically update the UI to be empty
                allTradesData = []; // Manually clear cache just in case
                updateAllUI();
                
            } catch (error) {
                 console.error("Error clearing all data: ", error);
                showModal("Error", "Could not clear all data. See console.");
            }
        };
        

        // --- Event Listeners ---

        const handleTradeSubmit = (e, commodity) => {
            e.preventDefault();
            const [buyInputId, sellInputId, errorMsgEl] = commodity === 'gold' 
                ? ['gold-buy-amount', 'gold-sell-amount', goldErrorMessageEl]
                : ['silver-buy-amount', 'silver-sell-amount', silverErrorMessageEl];
            if(!errorMsgEl) return;
            errorMsgEl.classList.add('hidden');
            const buyAmountStr = document.getElementById(buyInputId).value;
            const sellAmountStr = document.getElementById(sellInputId).value;
            const buyAmount = buyAmountStr === '' ? 0 : parseFloat(buyAmountStr);
            const sellAmount = sellAmountStr === '' ? 0 : parseFloat(sellAmountStr);
            if (isNaN(buyAmount) || isNaN(sellAmount)) {
                errorMsgEl.textContent = "Please enter valid numbers.";
                errorMsgEl.classList.remove('hidden');
                return;
            }
            if (buyAmount === 0 && sellAmount === 0) {
                errorMsgEl.textContent = "Please enter a Buy or Sell Amount.";
                errorMsgEl.classList.remove('hidden');
                return;
            }
            saveTrade({ buyAmount, sellAmount }, commodity);
        };

        if(goldTradeFormEl) goldTradeFormEl.addEventListener('submit', (e) => handleTradeSubmit(e, 'gold'));
        if(silverTradeFormEl) silverTradeFormEl.addEventListener('submit', (e) => handleTradeSubmit(e, 'silver'));

        if(editCancelButtonEl) editCancelButtonEl.addEventListener('click', () => {
            editModalEl.classList.add('hidden');
            editModalEl.classList.remove('flex');
        });
        
        //
        // FIX: This whole block was corrupted. Replaced with the correct version.
        //
        if(editTradeFormEl) editTradeFormEl.addEventListener('submit', (e) => {
            e.preventDefault();
            if(editErrorMessageEl) editErrorMessageEl.classList.add('hidden');
            const tradeId = editTradeIdEl.value;
            const buyAmountStr = editBuyAmountEl.value;
            const sellAmountStr = editSellAmountEl.value;
            const buyAmount = buyAmountStr === '' ? 0 : parseFloat(buyAmountStr);
            const sellAmount = sellAmountStr === '' ? 0 : parseFloat(sellAmountStr);

            if (isNaN(buyAmount) || isNaN(sellAmount)) {
                if(editErrorMessageEl) {
                    editErrorMessageEl.textContent = "Please enter valid numbers.";
                    editErrorMessageEl.classList.remove('hidden');
                }
                return;
            }
            if (buyAmount === 0 && sellAmount === 0) {
                if(editErrorMessageEl) {
                    editErrorMessageEl.textContent = "Please enter a Buy or Sell Amount.";
                    editErrorMessageEl.classList.remove('hidden');
                }
                return;
            }
            updateTrade(tradeId, { buyAmount, sellAmount });
        });

        // NEW: P&L Details Modal Logic
        
        /**
         * Generates and shows the P&L details modal
         * @param {string} commodity - 'gold', 'silver', or 'all'
         * @param {string} week - 'all' or a week number (e.g., '1', '2')
         */
        const showPlDetails = (commodity, week) => {
            if (!plDetailsModalEl || !plDetailsTitleEl || !plDetailsContentEl) return;

            let title = '';
            let filteredTrades = [];
            const weekMap = {};
            let weekCounter = 0;

            // 1. Filter trades by week
            if (week === 'all') {
                filteredTrades = allTradesData;
                title = `Total Realized P&L`;
            } else {
                // Find all trades for the specified week number
                allTradesData.forEach(trade => {
                    const monday = getMondayOfWeek(trade.timestamp);
                    let weekNum;
                    if (weekMap[monday] === undefined) {
                        weekCounter++;
                        weekMap[monday] = weekCounter.toString();
                    }
                    weekNum = weekMap[monday];
                    if (weekNum === week) {
                        filteredTrades.push(trade);
                    }
                });
                title = `Week ${week} Realized P&L`;
            }

            // 2. Filter by commodity and build content
            let contentHtml = '';
            let totalPL = 0;
            let totalPairs = 0;
            let totalProfit = 0;
            let totalCommission = 0;

            const buildHtml = (trades, commodityName) => {
                const plResult = calculateFifoPL(trades, commodityName);
                totalPL += plResult.totalPL;
                totalPairs += plResult.pairCount;
                totalProfit += plResult.totalProfit;
                totalCommission += plResult.totalCommission;

                let html = `<h4 class="text-lg font-bold ${commodityName === 'gold' ? 'text-yellow-400' : 'text-gray-300'} mb-2">${commodityName.charAt(0).toUpperCase() + commodityName.slice(1)} P&L</h4>`;
                if (plResult.pairs.length === 0) {
                    html += '<p class="text-gray-400 mb-4">No completed trade pairs for this period.</p>';
                    return html;
                }
                
                html += '<table class="min-w-full divide-y divide-gray-700 mb-4">';
                html += `<thead class="bg-gray-700"><tr>
                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-300 uppercase">Buy Rate</th>
                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-300 uppercase">Sell Rate</th>
                    <th class="px-2 py-2 text-right text-xs font-medium text-gray-300 uppercase">Profit</th>
                    <th class="px-2 py-2 text-right text-xs font-medium text-gray-300 uppercase">Commission</th>
                    <th class="px-2 py-2 text-right text-xs font-medium text-gray-300 uppercase">Net P&L</th>
                </tr></thead><tbody class="divide-y divide-gray-700">`;

                plResult.pairs.forEach(pair => {
                    html += `<tr>
                        <td class="px-2 py-2 text-green-400">${pair.buy.toFixed(2)}</td>
                        <td class="px-2 py-2 text-red-400">${pair.sell.toFixed(2)}</td>
                        <td class="px-2 py-2 text-right ${pair.profit > 0 ? 'text-green-400' : 'text-red-400'}">${pair.profit.toFixed(2)}</td>
                        <td class="px-2 py-2 text-right text-red-400">(${pair.commission.toFixed(2)})</td>
                        <td class="px-2 py-2 text-right font-medium ${pair.net > 0 ? 'text-green-400' : 'text-red-400'}">${pair.net.toFixed(2)}</td>
                    </tr>`;
                });

                html += '</tbody></table>';
                return html;
            };

            if (commodity === 'gold' || commodity === 'all') {
                contentHtml += buildHtml(filteredTrades.filter(t => t.commodity === 'gold'), 'gold');
            }
            if (commodity === 'silver' || commodity === 'all') {
                contentHtml += buildHtml(filteredTrades.filter(t => t.commodity === 'silver'), 'silver');
            }

            // 3. Add Summary
            if (commodity === 'all') {
                title += ' (Combined)';
            } else {
                title += ` (${commodity})`;
            }

            contentHtml += `<div class="mt-4 pt-4 border-t border-gray-700 font-medium">
                <div class="flex justify-between"><span>Total Profit:</span> <span class="text-green-400">${totalProfit.toFixed(2)}</span></div>
                <div class="flex justify-between"><span>Total Commission (${totalPairs} pairs):</span> <span class="text-red-400">(${totalCommission.toFixed(2)})</span></div>
                <div class="flex justify-between text-lg font-bold mt-2"><span>Final Net P&L:</span> <span class="${totalPL > 0 ? 'text-green-400' : (totalPL < 0 ? 'text-red-400' : 'text-white')}">${totalPL.toFixed(2)}</span></div>
            </div>`;

            // 4. Show Modal
            plDetailsTitleEl.textContent = title;
            plDetailsContentEl.innerHTML = contentHtml;
            plDetailsModalEl.classList.remove('hidden');
            plDetailsModalEl.classList.add('flex');
        };

        // Close button for P&L Details Modal
        if(plDetailsCloseButtonEl) plDetailsCloseButtonEl.addEventListener('click', () => {
            plDetailsModalEl.classList.add('hidden');
            plDetailsModalEl.classList.remove('flex');
        });

        // Event delegation for P&L Details buttons
        const reportContainer = document.getElementById('report-view');
        if (reportContainer) {
            reportContainer.addEventListener('click', (e) => {
                const target = e.target.closest('.pl-details-button');
                if (target) {
                    const commodity = target.dataset.commodity;
                    const week = target.dataset.week;
                    showPlDetails(commodity, week);
                }
            });
        }
        //
        // END OF FIX
        //

        if(deleteCancelButtonEl) deleteCancelButtonEl.addEventListener('click', () => {
            deleteModalEl.classList.add('hidden');
            deleteModalEl.classList.remove('flex');
        });
        
        if(deleteConfirmButtonEl) deleteConfirmButtonEl.addEventListener('click', () => {
            const tradeId = deleteTradeIdEl.value;
            deleteTrade(tradeId);
        });

        if(clearAllDataButtonEl) clearAllDataButtonEl.addEventListener('click', () => {
            if(clearDataModalEl) {
                clearDataModalEl.classList.remove('hidden');
                clearDataModalEl.classList.add('flex');
            }
        });

        if(clearDataCancelButtonEl) clearDataCancelButtonEl.addEventListener('click', () => {
            if(clearDataModalEl) {
                clearDataModalEl.classList.add('hidden');
                clearDataModalEl.classList.remove('flex');
            }
        });

        if(clearDataConfirmButtonEl) clearDataConfirmButtonEl.addEventListener('click', () => {
            clearAllData();
            if(clearDataModalEl) {
                clearDataModalEl.classList.add('hidden');
                clearDataModalEl.classList.remove('flex');
            }
        });

        // Auth Listeners
        if(gotoRegisterLinkEl) gotoRegisterLinkEl.addEventListener('click', (e) => { e.preventDefault(); window.location.hash = '#register'; });
        if(gotoLoginLinkEl) gotoLoginLinkEl.addEventListener('click', (e) => { e.preventDefault(); window.location.hash = '#login'; });
        
        if(registerFormEl) registerFormEl.addEventListener('submit', async (e) => {
            e.preventDefault();
            const mobileNumber = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;
            if(registerErrorEl) registerErrorEl.classList.add('hidden');
            
            // Validate 10 digit number
            if (!/^\d{10}$/.test(mobileNumber)) {
                if(registerErrorEl) {
                    registerErrorEl.textContent = "Mobile Number must be 10 digits.";
                    registerErrorEl.classList.remove('hidden');
                }
                return;
            }
            
            // Convert to fake email
            const email = PHONE_PREFIX + mobileNumber + FAKE_DOMAIN;

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                // Auth state change will handle the rest
                window.location.hash = '#dashboard';
            } catch (error) {
                console.error("Registration failed:", error);
                if(registerErrorEl) {
                    if (error.code === 'auth/email-already-in-use') {
                        registerErrorEl.textContent = "This mobile number is already taken.";
                    } else if (error.code === 'auth/weak-password') {
                        registerErrorEl.textContent = "Password is too weak. (Min 6 chars)";
                    } else if (error.code === 'auth/operation-not-allowed') {
                        registerErrorEl.textContent = "Configuration Error: Email/Password sign-in is not enabled in the Firebase project.";
                        showModal("Configuration Error", "Registration failed because the 'Email/Password' sign-in method is not enabled in your Firebase project. Please enable it in the Firebase Console -> Authentication -> Sign-in method.");
                    } else {
                        registerErrorEl.textContent = `Registration failed: ${error.message}`;
                    }
                    registerErrorEl.classList.remove('hidden');
                }
            }
        });

        if(loginFormEl) loginFormEl.addEventListener('submit', async (e) => {
            e.preventDefault();
            const mobileNumber = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            if(loginErrorEl) loginErrorEl.classList.add('hidden');

            // Convert to fake email
            const email = PHONE_PREFIX + mobileNumber + FAKE_DOMAIN;
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // Auth state change will handle the rest
                window.location.hash = '#dashboard';
            } catch (error) {
                console.error("Login failed:", error);
                if(loginErrorEl) {
                    if (error.code === 'auth/invalid-credential' || error.code === 'auth/invalid-email' || error.code === 'auth/wrong-password') {
                        loginErrorEl.textContent = "Invalid mobile number or password.";
                    } else if (error.code === 'auth/operation-not-allowed') {
                        loginErrorEl.textContent = "Configuration Error: Email/Password sign-in is not enabled.";
                        showModal("Configuration Error", "Login failed because the 'Email/Password' sign-in method is not enabled in your Firebase project. Please enable it in the Firebase Console -> Authentication -> Sign-in method.");
                    } else {
                        loginErrorEl.textContent = "An internal error occurred. Please try again.";
                    }
                    loginErrorEl.classList.remove('hidden');
                }
            }
        });

        if(signOutButtonEl) signOutButtonEl.addEventListener('click', () => {
            signOut(auth).catch((error) => {
                console.error("Sign out error", error);
                showModal("Error", "Could not sign out.");
            });
            // Auth state change will handle the rest
            window.location.hash = '#login';
        });

        // Table Listeners (using delegation)
        if(goldTradesBodyEl) goldTradesBodyEl.addEventListener('click', handleTableAction);
        if(silverTradesBodyEl) silverTradesBodyEl.addEventListener('click', handleTableAction);


        // NEW: Profile Form Listener
        if(profileDetailsFormEl) profileDetailsFormEl.addEventListener('submit', (e) => {
            e.preventDefault();
            saveProfileDetails();
        });


        // NEW: Gemini Insights Button Listener
        if(insightsButton) {
            insightsButton.addEventListener('click', async () => {
                if(insightsLoading) insightsLoading.style.display = 'flex';
                if(insightsContent) insightsContent.innerHTML = '';
                if(insightsSources) insightsSources.innerHTML = '';
                insightsButton.disabled = true;

                const prompt = "Provide a very brief, one-paragraph summary of the latest market news and price trends for Gold and Silver commodities.";

                try {
                    const { text, sources } = await callGeminiApi(prompt, true); // Enable grounding
                    
                    if(insightsContent) {
                        // Replace newlines with <br> tags for proper HTML rendering
                        insightsContent.innerHTML = text.replace(/\n/g, '<br>');
                    }

                    if (insightsSources && sources.length > 0) {
                        let sourcesHtml = '<h4 class="text-sm font-semibold text-gray-300 mt-4 mb-2">Sources:</h4><ul class="list-disc list-inside space-y-1">';
                        sources.forEach(source => {
                            // Truncate long titles for better UI
                            const title = source.title.length > 80 ? source.title.substring(0, 80) + '...' : source.title;
                            sourcesHtml += `<li><a href="${source.uri}" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:underline" title="${source.title}">${title}</a></li>`;
                        });
                        sourcesHtml += '</ul>';
                        insightsSources.innerHTML = sourcesHtml;
                    }

                } catch (error) {
                    console.error("Failed to get market insights:", error);
                    if(insightsContent) insightsContent.innerHTML = `<p class="text-red-400">Could not load insights. ${error.message}</p>`;
                } finally {
                    if(insightsLoading) insightsLoading.style.display = 'none';
                    insightsButton.disabled = false;
                }
            });
        }


        // --- Initial Page Load ---
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // NEW: Log the project ID so the user can verify it.
                console.log("Connecting to Firebase project:", firebaseConfig.projectId);

                setLogLevel('debug');
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                if(authStatusEl) authStatusEl.textContent = 'Initializing...';
                
                // This is the new "main" function
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // USER IS LOGGED IN
                        userId = user.uid;
                        // FIX: Extract mobile number correctly using the prefix
                        username = user.email.replace(PHONE_PREFIX, "").split('@')[0];
                        
                        // Update UI
                        mainAppContainerEl.classList.remove('hidden');
                        authContainerEl.style.display = 'none'; // Use style.display to remove from flow
                        authFooterEl.classList.add('hidden');
                        appFooterEl.classList.remove('hidden');
                        if(userUsernameDisplayEl) userUsernameDisplayEl.textContent = username; // CHANGED (now shows number)
                        if(footerUserUsernameEl) footerUserUsernameEl.textContent = username; // CHANGED (now shows number)
                        if(authStatusEl) authStatusEl.textContent = 'Authenticated successfully.';
                        if(goldSubmitButton) goldSubmitButton.disabled = false;
                        if(silverSubmitButton) silverSubmitButton.disabled = false;

                        // Start data listeners
                        listenForTrades(); 
                        loadProfileDetails(); // NEW: Load profile data on login
                        
                    } else {
                        // USER IS LOGGED OUT
                        userId = null;
                        username = null; // CHANGED (clears number)
                        if (unsubscribeFromTrades) unsubscribeFromTrades(); // Stop listening
                        allTradesData = []; // Clear data cache
                        updateAllUI(); // Clear UI
                        
                        // Update UI
                        mainAppContainerEl.classList.add('hidden');
                        authContainerEl.style.display = 'block';
                        authFooterEl.classList.remove('hidden');
        
                        appFooterEl.classList.add('hidden');
                        if(goldSubmitButton) goldSubmitButton.disabled = true;
                        if(silverSubmitButton) silverSubmitButton.disabled = true;
                    }
                    
                    // Always run the router to show the correct page
                    handleHashChange();
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                if(authStatusEl) authStatusEl.textContent = 'Error initializing Firebase.';
                showModal("Firebase Error", "Could not initialize Firebase. Please check your config.");
                // Show auth view even if Firebase fails, so user isn't stuck
                mainAppContainerEl.classList.add('hidden');
                authContainerEl.style.display = 'block';
                handleHashChange();
            }
        });
        
    </script>
</body>
</html>