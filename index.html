<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commodity Trade Tracker</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Custom vertical scrollbar for dark theme */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px; /* Added height for horizontal */
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        /* Custom horizontal scrollbar for nav */
        nav::-webkit-scrollbar {
            height: 4px; /* Slimmer scrollbar for nav */
        }
        nav::-webkit-scrollbar-track {
            background: transparent; /* Make nav scrollbar track invisible */
        }
        nav::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 10px;
        }

        /* Style for hidden views */
        .page-view, .report-page-view {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4 sm:p-8">

    <div id="app" class="max-w-6xl mx-auto pt-4">

        <!-- NEW: Auth Container (Login / Register) - Shown by default -->
        <div id="auth-container">
            <!-- Login View -->
            <div id="login-view" class="page-view max-w-md mx-auto bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl border border-gray-700">
                <h2 class="text-3xl font-bold text-center text-white mb-6">Login</h2>
                <form id="login-form" class="space-y-4">
                    <div>
                        <!-- CHANGED from Username to Mobile Number -->
                        <label for="login-username" class="block text-sm font-medium text-gray-300 mb-1">Mobile Number</label>
                        <input type="tel" id="login-username" required placeholder="Enter 10-digit number"
                               class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-300 mb-1">Password</label>
                        <input type="password" id="login-password" required
                               class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                    </div>
                    <p id="login-error" class="text-red-400 text-sm hidden"></p>
                    <button type="submit" id="login-button"
                            class="w-full py-2 px-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-md transition duration-150">
                        Login
                    </button>
                </form>
                <p class="text-center text-sm text-gray-400 mt-6">
                    Don't have an account? 
                    <a href="#register" id="goto-register-link" class="font-medium text-blue-400 hover:underline">Sign Up</a>
                </p>
            </div>

            <!-- Register View -->
            <div id="register-view" class="page-view max-w-md mx-auto bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl border border-gray-700">
                <h2 class="text-3xl font-bold text-center text-white mb-6">Create Account</h2>
                <form id="register-form" class="space-y-4">
                    <div>
                        <!-- CHANGED from Username to Mobile Number -->
                        <label for="register-username" class="block text-sm font-medium text-gray-300 mb-1">Mobile Number</label>
                        <input type="tel" id="register-username" required minlength="10" maxlength="10" placeholder="Enter 10-digit number"
                               class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                    </div>
                    <div>
                        <label for="register-password" class="block text-sm font-medium text-gray-300 mb-1">Password</label>
                        <input type="password" id="register-password" required minlength="6"
                               class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                    </div>
                    <p id="register-error" class="text-red-400 text-sm hidden"></p>
                    <button type="submit" id="register-button"
                            class="w-full py-2 px-4 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg shadow-md transition duration-150">
                        Create Account
                    </button>
                </form>
                <p class="text-center text-sm text-gray-400 mt-6">
                    Already have an account? 
                    <a href="#login" id="goto-login-link" class="font-medium text-blue-400 hover:underline">Login</a>
                </p>
            </div>
        </div>

        <!-- NEW: Main App Container - Hidden by default -->
        <div id="main-app-container" class="hidden">
            <!-- Navigation Bar -->
            <nav class="mb-6 p-2 bg-gray-800 rounded-xl shadow-lg flex justify-start flex-nowrap overflow-x-auto space-x-2 sm:space-x-4 border border-gray-700"> 
                <a href="#dashboard" id="nav-dashboard" class="nav-link py-2 px-4 rounded-lg font-semibold text-gray-300 hover:bg-gray-700 transition duration-150 whitespace-nowrap">
                    Dashboard
                </a>
                <a href="#gold" id="nav-gold" class="nav-link py-2 px-4 rounded-lg font-semibold text-gray-300 hover:bg-gray-700 transition duration-150 whitespace-nowrap">
                    Gold Mini
                </a>
                <a href="#silver" id="nav-silver" class="nav-link py-2 px-4 rounded-lg font-semibold text-gray-300 hover:bg-gray-700 transition duration-150 whitespace-nowrap">
                    Silver Mini
                </a>
                <a href="#report" id="nav-report" class="nav-link py-2 px-4 rounded-lg font-semibold text-gray-300 hover:bg-gray-700 transition duration-150 whitespace-nowrap">
                    Report
                </a>
                <!-- Renamed Settings to Profile -->
                <a href="#profile" id="nav-profile" class="nav-link py-2 px-4 rounded-lg font-semibold text-gray-300 hover:bg-gray-700 transition duration-150 whitespace-nowrap">
                    Profile
                </a>
            </nav>
            
            <!-- DASHBOARD VIEW (Home Page) -->
            <div id="dashboard-view" class="page-view">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    
                    <!-- New Gold Card -->
                    <div class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700">
                        <h2 class="text-xl font-bold text-yellow-400 mb-4">Gold Mini - Current Week</h2>
                        <div class="flex justify-around items-center space-x-4">
                            <!-- Avg Buy -->
                            <div class="text-center">
                                <p class="text-sm font-medium text-green-400 uppercase">Avg. Buy</p>
                                <p id="gold-avg-buy" class="text-3xl sm:text-4xl font-extrabold text-green-400 mt-1">0.00</p>
                            </div>
                            <!-- Avg Sell -->
                            <div class="text-center">
                                <p class="text-sm font-medium text-red-400 uppercase">Avg. Sell</p>
                                <p id="gold-avg-sell" class="text-3xl sm:text-4xl font-extrabold text-red-400 mt-1">0.00</p>
                            </div>
                        </div>
                        <p id="gold-trade-count" class="text-sm text-gray-400 mt-4 text-center">Based on 0 trades this week.</p>
                    </div>

                    <!-- New Silver Card -->
                    <div class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700">
                        <h2 class="text-xl font-bold text-gray-300 mb-4">Silver Mini - Current Week</h2>
                        <div class="flex justify-around items-center space-x-4">
                            <!-- Avg Buy -->
                            <div class="text-center">
                                <p class="text-sm font-medium text-green-400 uppercase">Avg. Buy</p>
                                <p id="silver-avg-buy" class="text-3xl sm:text-4xl font-extrabold text-green-400 mt-1">0.00</p>
                            </div>
                            <!-- Avg Sell -->
                            <div class="text-center">
                                <p class="text-sm font-medium text-red-400 uppercase">Avg. Sell</p>
                                <p id="silver-avg-sell" class="text-3xl sm:text-4xl font-extrabold text-red-400 mt-1">0.00</p>
                            </div>
                        </div>
                        <p id="silver-trade-count" class="text-sm text-gray-400 mt-4 text-center">Based on 0 trades this week.</p>
                    </div>

                </div>

                <!-- NEW: Gemini Market Insights Card -->
                <div id="market-insights-card" class="mt-6 bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700">
                    <h2 class="text-2xl font-bold text-blue-400 mb-4">âœ¨ Market Insights</h2>
                    <button id="get-market-insights-button" class="w-full sm:w-auto py-2 px-5 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-md transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                        Get Latest News
                    </button>
                    
                    <!-- Loading Spinner -->
                    <div id="insights-loading" class="hidden mt-4 flex justify-center items-center">
                        <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-400"></div>
                        <p class="ml-3 text-gray-300">Fetching live market data...</p>
                    </div>

                    <!-- AI Content Area -->
                    <div id="insights-content" class="mt-4 text-gray-300 text-sm leading-relaxed">
                        <!-- AI-generated content will appear here -->
                    </div>
                    
                    <!-- AI Sources Area -->
                    <div id="insights-sources" class="mt-4 text-xs">
                        <!-- AI-generated sources will appear here -->
                    </div>
                </div>

            </div>

            <!-- GOLD MINI TRADE ENTRY VIEW -->
            <div id="gold-view" class="page-view">
                <!-- Gold Trade Entry Form -->
                <div class="bg-gray-800 p-4 sm:p-6 rounded-xl shadow-2xl mb-8 border border-yellow-700">
                    <h2 class="text-2xl font-semibold mb-4 text-yellow-400">New Gold Mini Trade</h2>
                    <form id="gold-trade-form" class="grid grid-cols-2 gap-4 sm:grid-cols-3 sm:gap-6">
                        <div class="col-span-1">
                            <label for="gold-buy-amount" class="block text-sm font-medium text-green-400 mb-1">Buy Amount</label>
                            <input type="number" id="gold-buy-amount" placeholder="Enter buy amount" step="any" min="0"
                                   class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-green-500 focus:border-green-500 transition duration-150">
                        </div>
                        <div class="col-span-1">
                            <label for="gold-sell-amount" class="block text-sm font-medium text-red-400 mb-1">Sell Amount</label>
                            <input type="number" id="gold-sell-amount" placeholder="Enter sell amount" step="any" min="0"
                                   class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-red-500 focus:border-red-500 transition duration-150">
                        </div>
                        <div class="col-span-2 sm:col-span-1 flex items-end">
                            <button type="submit" id="gold-submit-button" disabled
                                    class="w-full py-2 px-4 bg-yellow-600 hover:bg-yellow-500 text-gray-900 font-bold rounded-lg shadow-md transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                                Add Gold Trade
                            </button>
                        </div>
                    </form>
                    <p id="gold-error-message" class="text-red-400 text-sm mt-3 hidden"></p>
                </div>
                <!-- Gold Trades Table -->
                <div class="bg-gray-800 p-4 sm:p-6 rounded-xl shadow-2xl border border-gray-700">
                    <h2 class="text-2xl font-semibold mb-4 text-white">Gold Trade History</h2>
                    <div class="overflow-x-auto rounded-lg">
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Week</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Date</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-green-400 uppercase tracking-wider">Buy Amount</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-red-400 uppercase tracking-wider">Sell Amount</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="gold-trades-body" class="bg-gray-800 divide-y divide-gray-700">
                                <tr><td colspan="5" class="px-3 py-4 text-center text-sm text-gray-400" id="gold-loading-message">Loading trades...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- SILVER MINI TRADE ENTRY VIEW -->
            <div id="silver-view" class="page-view">
                <!-- Silver Trade Entry Form -->
                <div class="bg-gray-800 p-4 sm:p-6 rounded-xl shadow-2xl mb-8 border border-gray-600">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-300">New Silver Mini Trade</h2>
                    <form id="silver-trade-form" class="grid grid-cols-2 gap-4 sm:grid-cols-3 sm:gap-6">
                        <div class="col-span-1">
                            <label for="silver-buy-amount" class="block text-sm font-medium text-green-400 mb-1">Buy Amount</label>
                            <input type="number" id="silver-buy-amount" placeholder="Enter buy amount" step="any" min="0"
                                   class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-green-500 focus:border-green-500 transition duration-150">
                        </div>
                        <div class="col-span-1">
                            <label for="silver-sell-amount" class="block text-sm font-medium text-red-400 mb-1">Sell Amount</label>
                            <input type="number" id="silver-sell-amount" placeholder="Enter sell amount" step="any" min="0"
                                   class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-red-500 focus:border-red-500 transition duration-150">
                        </div>
                        <div class="col-span-2 sm:col-span-1 flex items-end">
                            <button type="submit" id="silver-submit-button" disabled
                                    class="w-full py-2 px-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-md transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                                Add Silver Trade
                            </button>
                        </div>
                    </form>
                    <p id="silver-error-message" class="text-red-400 text-sm mt-3 hidden"></p>
                </div>
                <!-- Silver Trades Table -->
                <div class="bg-gray-800 p-4 sm:p-6 rounded-xl shadow-2xl border border-gray-700">
                    <h2 class="text-2xl font-semibold mb-4 text-white">Silver Trade History</h2>
                    <div class="overflow-x-auto rounded-lg">
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Week</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Date</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-green-400 uppercase tracking-wider">Buy Amount</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-red-400 uppercase tracking-wider">Sell Amount</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="silver-trades-body" class="bg-gray-800 divide-y divide-gray-700">
                                <tr><td colspan="5" class="px-3 py-4 text-center text-sm text-gray-400" id="silver-loading-message">Loading trades...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- REPORT VIEW -->
            <div id="report-view" class="page-view">
                <!-- Report Sub-Navigation -->
                <nav id="report-sub-nav" class="mb-4 p-2 bg-gray-800 rounded-xl shadow-lg flex justify-start flex-nowrap overflow-x-auto space-x-2 sm:space-x-4 border border-gray-700">
                    <a href="#report-overall" class="report-nav-link py-2 px-4 rounded-lg font-semibold text-gray-300 hover:bg-gray-700 transition duration-150 whitespace-nowrap">
                        Overall Report
                    </a>
                    <a href="#report-gold" class="report-nav-link py-2 px-4 rounded-lg font-semibold text-gray-300 hover:bg-gray-700 transition duration-150 whitespace-nowrap">
                        Gold Report
                    </a>
                    <a href="#report-silver" class="report-nav-link py-2 px-4 rounded-lg font-semibold text-gray-300 hover:bg-gray-700 transition duration-150 whitespace-nowrap">
                        Silver Report
                    </a>
                </nav>
                <!-- Overall Report View -->
                <div id="report-overall-view" class="report-page-view">
                    <div class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700">
                        <h2 class="text-2xl font-bold text-green-400 mb-6">Overall Summary</h2>
                        <div class="flex flex-nowrap overflow-x-auto space-x-6 pb-4">
                            <!-- Gold Report -->
                            <div class="bg-gray-700 p-6 rounded-lg min-w-96">
                                <h3 class="text-lg font-semibold text-yellow-400 mb-3">Gold Mini Net Position</h3>
                                <p id="gold-report-summary" class="text-sm text-gray-300 mb-4">Calculating...</p>
                                <div class="text-4xl font-extrabold" id="gold-net-position">0.00</div>
                            </div>
                            <!-- Silver Report -->
                            <div class="bg-gray-700 p-6 rounded-lg min-w-96">
                                <h3 class="text-lg font-semibold text-gray-300 mb-3">Silver Mini Net Position</h3>
                                <p id="silver-report-summary" class="text-sm text-gray-300 mb-4">Calculating...</p>
                                <div class="text-4xl font-extrabold" id="silver-net-position">0.00</div>
                            </div>
                            <!-- Combined Report -->
                            <div class="bg-gray-700 p-6 rounded-lg min-w-96">
                                <h3 class="text-lg font-semibold text-white mb-3">Combined Net Position</h3>
                                <p id="combined-report-summary" class="text-sm text-gray-300 mb-4">Calculating...</p>
                                <div class="text-4xl font-extrabold" id="combined-net-position">0.00</div>
                            </div>
                        </div> <!-- End Scroller -->
                    </div>
                </div>
                <!-- Gold-Only Report View -->
                <div id="report-gold-view" class="report-page-view">
                    <div class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700">
                        <h2 class="text-2xl font-bold text-yellow-400 mb-6">Gold Mini Report</h2>
                        <div class="bg-gray-700 p-6 rounded-lg">
                            <h3 class="text-lg font-semibold text-yellow-400 mb-3">Gold Mini Net Position</h3>
                            <p id="gold-report-summary-solo" class="text-sm text-gray-300 mb-4">Calculating...</p>
                            <div class="text-4xl font-extrabold" id="gold-net-position-solo">0.00</div>
                        </div>
                    </div>
                </div>
                <!-- Silver-Only Report View -->
                <div id="report-silver-view" class="report-page-view">
                    <div class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700">
                        <h2 class="text-2xl font-bold text-gray-300 mb-6">Silver Mini Report</h2>
                        <div class="bg-gray-700 p-6 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-300 mb-3">Silver Mini Net Position</h3>
                            <p id="silver-report-summary-solo" class="text-sm text-gray-300 mb-4">Calculating...</p>
                            <div class="text-4xl font-extrabold" id="silver-net-position-solo">0.00</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PROFILE & SETTINGS VIEW (Replaced Settings) -->
            <div id="profile-view" class="page-view">
                <div class="space-y-6">
                    <div class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700">
                        <h2 class="text-2xl font-bold text-blue-400 mb-6">Profile & Settings</h2>
                        
                        <!-- Profile Info -->
                        <div class="max-w-md mb-8">
                            <h3 class="text-lg font-semibold text-white mb-2">Account</h3>
                            <p class="text-gray-400 text-sm">
                                <!-- CHANGED from Username to Mobile Number -->
                                Logged in with: <span id="user-username-display" class="font-bold text-yellow-400"></span>
                            </p>
                            <button id="sign-out-button" class="w-full mt-4 py-2 px-4 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-lg shadow-md transition duration-150">
                                Sign Out
                            </button>
                        </div>

                        <!-- Firebase Setup Info Box -->
                        <div id="cloud-settings-info" class="p-4 bg-gray-700 border border-yellow-600 rounded-lg mb-8">
                            <h4 class="font-bold text-yellow-400 mb-2">How to Set Up Cloud Storage</h4>
                            <ol class="list-decimal list-inside text-gray-300 text-sm space-y-2">
                                <li>Go to <a href="https://firebase.google.com/" target="_blank" class="text-blue-400 underline">Firebase</a> and create a new project.</li>
                                <li>In your project, go to "Build" > "Authentication" > "Sign-in method" and enable **Email/Password**.</li>
                                <li>
                                    Go to "Build" > "Firestore Database" > "Create database".
                                    It may ask you to <b class="text-red-400">Enable Billing</b> (this is a one-time verification, you won't be charged).
                                    Then, **SECURE YOUR DATABASE** by going to the **"Rules"** tab and pasting in:
                                    <pre class="bg-gray-900 p-2 rounded-md text-xs mt-2 overflow-x-auto">rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /artifacts/{appId}/users/{userId}/commodity_trades/{tradeId} {
      allow read, write, delete: if request.auth.uid == userId;
    }
  }
}</pre>
                                </li>
                                <li>Go to your Project Settings (gear icon) > "General".</li>
                                <li>Find the "SDK setup and configuration" section and copy the `firebaseConfig` object.</li>
                                <li>Paste your config object into this file's script tag, replacing the `firebaseConfigPlaceholder`.</li>
                            </ol>
                        </div>

                        <!-- Danger Zone for clearing data -->
                        <div class="max-w-md">
                            <h3 class="text-lg font-semibold text-red-400 mb-2">Danger Zone</h3>
                            <p class="text-gray-400 mb-4 text-sm">This action will permanently delete all trade data *from your account*. This cannot be undone.</p>
                            <button id="clear-all-data-button" class="py-2 px-5 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg shadow-md transition duration-150">
                                Clear All Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>
    
        </div> <!-- End Main App Container -->

        <!-- Footer/Info -->
        <div class="mt-8 text-xs text-center text-gray-500">
            <!-- This footer is now for the main app -->
            <div id="app-footer" class="hidden">
                <!-- CHANGED from Username to Mobile Number -->
                Logged in with: <span id="footer-user-username" class="font-mono text-yellow-400"></span>
                <div id="auth-status" class="mt-2 text-gray-500">Authenticating...</div> 
            </div>
            <div id="auth-footer">
                Please log in or sign up to continue.
            </div>
        </div>

        <!-- Modal for Custom Alert/Error -->
        <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full border border-gray-700">
                <h3 id="modal-title" class="text-xl font-bold text-white mb-4"></h3>
                <p id="modal-content" class="text-gray-300 mb-6"></p>
                <button id="modal-close" class="w-full py-2 px-4 bg-yellow-600 hover:bg-yellow-500 text-gray-900 font-bold rounded-lg transition duration-150">
                    Close
                </button>
            </div>
        </div>

        <!-- Modal for Editing Trades -->
        <div id="edit-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full border border-gray-700">
                <form id="edit-trade-form">
                    <h3 id="edit-modal-title" class="text-xl font-bold text-white mb-4">Edit Trade</h3>
                    <input type="hidden" id="edit-trade-id">
                    <div class="mb-4">
                        <label for="edit-buy-amount" class="block text-sm font-medium text-green-400 mb-1">Buy Amount</label>
                        <input type="number" id="edit-buy-amount" step="any" min="0"
                               class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-green-500 focus:border-green-500 transition duration-150">
                    </div>
                    <div class="mb-6">
                        <label for="edit-sell-amount" class="block text-sm font-medium text-red-400 mb-1">Sell Amount</label>
                        <input type="number" id="edit-sell-amount" step="any" min="0"
                               class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-red-500 focus:border-red-500 transition duration-150">
                    </div>
                    <p id="edit-error-message" class="text-red-400 text-sm mb-4 hidden"></p>
                    <div class="flex space-x-4">
                        <button type="button" id="edit-cancel-button" class="w-1/2 py-2 px-4 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-lg transition duration-150">
                            Cancel
                        </button>
                        <button type="submit" id="edit-save-button" class="w-1/2 py-2 px-4 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg transition duration-150">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Modal for Delete Confirmation -->
        <div id="delete-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full border border-red-700">
                <h3 id="delete-modal-title" class="text-xl font-bold text-red-400 mb-4">Confirm Deletion</h3>
                <p id="delete-modal-content" class="text-gray-300 mb-6">Are you sure you want to delete this trade? This action cannot be undone.</p>
                <input type="hidden" id="delete-trade-id">
                <div class="flex space-x-4">
                    <button type="button" id="delete-cancel-button" class="w-1/2 py-2 px-4 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-lg transition duration-150">
                        Cancel
                    </button>
                    <button type="button" id="delete-confirm-button" class="w-1/2 py-2 px-4 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg transition duration-150">
                        Delete
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal for Clear All Data Confirmation -->
        <div id="clear-data-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full border border-red-700">
                <h3 class="text-xl font-bold text-red-400 mb-4">Confirm Clear All Data</h3>
                <p class="text-gray-300 mb-6">Are you sure you want to delete ALL trades? This action cannot be undone.</Fp>
                <div class="flex space-x-4">
                    <button type="button" id="clear-data-cancel-button" class="w-1/2 py-2 px-4 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-lg transition duration-150">
                        Cancel
                    </button>
                    <button type="button" id="clear-data-confirm-button" class="w-1/2 py-2 px-4 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg transition duration-150">
                        DELETE ALL
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        // Firebase imports: Added Email/Password Auth and SignOut
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut,
            signInAnonymously, // Keep for placeholder
            signInWithCustomToken // Keep for env
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            addDoc, 
            onSnapshot, 
            collection, 
            query, 
            serverTimestamp, 
            setLogLevel, 
            deleteDoc, 
            updateDoc,
            writeBatch, // Added for clear all data
            getDocs // Added for clear all data
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config Placeholder ---
        // This is your actual config object
        const hardcodedFirebaseConfig = {
            apiKey: "AIzaSyAYy9FONBnwilc2f3WdTCGFQ2-W3jQvE3E",
            authDomain: "parth-trading.firebaseapp.com",
            projectId: "parth-trading",
            storageBucket: "parth-trading.firebasestorage.app",
            messagingSenderId: "629101446151",
            appId: "1:629101446151:web:d91110064a8889497916a2",
            measurementId: "G-7JQ523ETHN"
        };
        // ---
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfigFromEnv = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Use environment config if available, otherwise use the hardcoded one
        // FIX: Renamed the variable to avoid redeclaration
        let firebaseConfig = (firebaseConfigFromEnv && Object.keys(firebaseConfigFromEnv).length > 0) 
            ? firebaseConfigFromEnv 
            : hardcodedFirebaseConfig; 

        // Firebase App variables
        let db;
        let auth;
        let userId = null;
        let username = null; // CHANGED from userEmail

        // Data cache
        let allTradesData = [];
        let unsubscribeFromTrades = null; // To stop listener on sign-out

        // --- DOM Elements ---
        const modalEl = document.getElementById('custom-modal');
        const modalTitleEl = document.getElementById('modal-title');
        const modalContentEl = document.getElementById('modal-content');
        const modalCloseEl = document.getElementById('modal-close');
        
        // Page Views & Containers
        const mainAppContainerEl = document.getElementById('main-app-container');
        const authContainerEl = document.getElementById('auth-container');
        const loginViewEl = document.getElementById('login-view');
        const registerViewEl = document.getElementById('register-view');
        const dashboardViewEl = document.getElementById('dashboard-view');
        const goldViewEl = document.getElementById('gold-view');
        const silverViewEl = document.getElementById('silver-view');
        const reportViewEl = document.getElementById('report-view');
        const profileViewEl = document.getElementById('profile-view'); // Renamed
        const navLinks = document.querySelectorAll('.nav-link');
 
        // Gold Elements
        const goldTradeFormEl = document.getElementById('gold-trade-form');
        const goldSubmitButton = document.getElementById('gold-submit-button');
        const goldErrorMessageEl = document.getElementById('gold-error-message');
        const goldLoadingMessageEl = document.getElementById('gold-loading-message');
        const goldTradesBodyEl = document.getElementById('gold-trades-body');
        
        // Silver Elements
        const silverTradeFormEl = document.getElementById('silver-trade-form');
        const silverSubmitButton = document.getElementById('silver-submit-button');
        const silverErrorMessageEl = document.getElementById('silver-error-message');
        const silverLoadingMessageEl = document.getElementById('silver-loading-message');
        const silverTradesBodyEl = document.getElementById('silver-trades-body');

        // Dashboard Elements
        const goldAvgBuyEl = document.getElementById('gold-avg-buy');
        const goldAvgSellEl = document.getElementById('gold-avg-sell');
        const goldTradeCountEl = document.getElementById('gold-trade-count');
        const silverAvgBuyEl = document.getElementById('silver-avg-buy');
        const silverAvgSellEl = document.getElementById('silver-avg-sell');
        const silverTradeCountEl = document.getElementById('silver-trade-count');

        // Report Elements
        const goldReportSummaryEl = document.getElementById('gold-report-summary');
        const goldNetPositionEl = document.getElementById('gold-net-position');
        const silverReportSummaryEl = document.getElementById('silver-report-summary');
        const silverNetPositionEl = document.getElementById('silver-net-position');
        const combinedReportSummaryEl = document.getElementById('combined-report-summary');
        const combinedNetPositionEl = document.getElementById('combined-net-position');
        const goldReportSummarySoloEl = document.getElementById('gold-report-summary-solo');
        const goldNetPositionSoloEl = document.getElementById('gold-net-position-solo');
        const silverReportSummarySoloEl = document.getElementById('silver-report-summary-solo');
        const silverNetPositionSoloEl = document.getElementById('silver-net-position-solo');
        const reportOverallViewEl = document.getElementById('report-overall-view');
        const reportGoldViewEl = document.getElementById('report-gold-view');
        const reportSilverViewEl = document.getElementById('report-silver-view');
        const reportNavLinks = document.querySelectorAll('.report-nav-link');
 
        // Edit Modal Elements
        const editModalEl = document.getElementById('edit-modal');
        const editModalTitleEl = document.getElementById('edit-modal-title');
        const editTradeFormEl = document.getElementById('edit-trade-form');
        const editTradeIdEl = document.getElementById('edit-trade-id');
        const editBuyAmountEl = document.getElementById('edit-buy-amount');
        const editSellAmountEl = document.getElementById('edit-sell-amount');
        const editErrorMessageEl = document.getElementById('edit-error-message');
        const editCancelButtonEl = document.getElementById('edit-cancel-button');
        
        // Delete Modal Elements
        const deleteModalEl = document.getElementById('delete-modal');
        const deleteTradeIdEl = document.getElementById('delete-trade-id');
        const deleteCancelButtonEl = document.getElementById('delete-cancel-button');
        const deleteConfirmButtonEl = document.getElementById('delete-confirm-button');

        // Clear Data Modal Elements
        const clearAllDataButtonEl = document.getElementById('clear-all-data-button');
        const clearDataModalEl = document.getElementById('clear-data-modal');
        const clearDataCancelButtonEl = document.getElementById('clear-data-cancel-button');
        const clearDataConfirmButtonEl = document.getElementById('clear-data-confirm-button');

        // Profile & Auth Elements
        const loginFormEl = document.getElementById('login-form');
        const registerFormEl = document.getElementById('register-form');
        const loginErrorEl = document.getElementById('login-error');
        const registerErrorEl = document.getElementById('register-error');
        const gotoRegisterLinkEl = document.getElementById('goto-register-link');
        const gotoLoginLinkEl = document.getElementById('goto-login-link');
        const userUsernameDisplayEl = document.getElementById('user-username-display'); // CHANGED (now holds number)
        const signOutButtonEl = document.getElementById('sign-out-button');
        const authStatusEl = document.getElementById('auth-status');
        const appFooterEl = document.getElementById('app-footer');
        const authFooterEl = document.getElementById('auth-footer');
        const footerUserUsernameEl = document.getElementById('footer-user-username'); // CHANGED (now holds number)

        // NEW: Gemini Insights Elements
        const insightsButton = document.getElementById('get-market-insights-button');
        const insightsLoading = document.getElementById('insights-loading');
        const insightsContent = document.getElementById('insights-content');
        const insightsSources = document.getElementById('insights-sources');


        // --- Utility Functions ---
        
        // This is the (hidden) domain we'll add to usernames to make them "emails"
        const FAKE_DOMAIN = "@trade-tracker.app";
        // FIX: Add a prefix to make the email valid for sign-in
        const PHONE_PREFIX = "phone-";

        /**
         * Refreshes all UI components (tables, dashboard) from 'allTradesData'.
         */
        const updateAllUI = () => {
            allTradesData.sort((a, b) => {
                const dateA = a.timestamp?.toDate ? a.timestamp.toDate() : new Date(a.timestamp || 0);
                const dateB = b.timestamp?.toDate ? b.timestamp.toDate() : new Date(b.timestamp || 0);
                return dateA - dateB;
            });
            
            updateDashboardAndReport(allTradesData); 
            renderHistoryTable('gold', goldTradesBodyEl, goldLoadingMessageEl);
            renderHistoryTable('silver', silverTradesBodyEl, silverLoadingMessageEl);
        };

        const formatDate = (timestamp) => {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' }).replace(/\//g, '/');
        };

        const toStorageDate = (date) => {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        };

        const showModal = (title, content) => {
            modalTitleEl.textContent = title;
            modalContentEl.textContent = content;
            modalEl.classList.remove('hidden');
            modalEl.classList.add('flex');
        };

        modalCloseEl.addEventListener('click', () => {
            modalEl.classList.add('hidden');
            modalEl.classList.remove('flex');
        });
        
        const getMondayOfWeek = (dateInput) => {
            let d;
            if (!dateInput) {
                d = new Date();
            } else {
                d = dateInput.toDate ? dateInput.toDate() : new Date(dateInput);
            }
            d.setHours(0, 0, 0, 0);
            let day = d.getDay(); 
            let daysToSubtract = day === 0 ? 6 : day - 1;
            d.setDate(d.getDate() - daysToSubtract);
            return toStorageDate(d);
        };

        // --- NEW: Gemini API Functions ---

        // Function to handle exponential backoff
        const sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

        /**
         * Calls the Gemini API with exponential backoff.
         * @param {string} prompt The user prompt to send.
         * @param {boolean} useGrounding Whether to enable Google Search grounding.
         */
        async function callGeminiApi(prompt, useGrounding = false) {
            // FIX: Add your Gemini API Key here.
            const apiKey = "YOUR_GEMINI_API_KEY"; // Will be populated by the environment
            // FIX: Corrected the model name.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-preview-0514:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
            };

            if (useGrounding) {
                payload.tools = [{ "google_search": {} }];
            }

            let response;
            let retries = 5;
            let delay = 1000; // 1 second

            for (let i = 0; i < retries; i++) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const candidate = result.candidates?.[0];

                        if (candidate && candidate.content?.parts?.[0]?.text) {
                            const text = candidate.content.parts[0].text;
                            let sources = [];
                            const groundingMetadata = candidate.groundingMetadata;

                            if (useGrounding && groundingMetadata && groundingMetadata.groundingAttributions) {
                                sources = groundingMetadata.groundingAttributions
                                    .map(attribution => ({
                                        uri: attribution.web?.uri,
                                        title: attribution.web?.title,
                                    }))
                                    .filter(source => source.uri && source.title); // Ensure sources are valid
                            }
                            // Success: return text and sources
                            return { text, sources };
                        } else {
                            // This case is if the API call succeeded but returned no text
                            throw new Error("API returned no content.");
                        }
                    } else if (response.status === 429 || response.status >= 500) {
                        // Throttling or server error, wait and retry
                        if (i === retries - 1) {
                            throw new Error(`API request failed after ${retries} attempts with status: ${response.status}`);
                        }
                        // Do not log retry attempts to the console as errors
                        await sleep(delay);
                        delay *= 2; // Exponential backoff
                    } else {
                        // Other client-side error (e.g., 400 Bad Request)
                        const errorResult = await response.json();
                        console.error("API request failed with client error:", errorResult);
                        throw new Error(`API request failed: ${errorResult.error?.message || response.statusText}`);
                    }
                } catch (error) {
                    // Network error or fetch failure
                    console.error("Fetch error:", error);
                    if (i === retries - 1) {
                        throw error; // Re-throw last error
                    }
                    // Do not log retry attempts to the console as errors
                    await sleep(delay);
                    delay *= 2;
                }
            }
            // This should not be reachable, but as a fallback:
            throw new Error("Failed to get response from API after all retries.");
        }


        // --- UI Rendering Functions ---

        const openDeleteModal = (tradeId) => {
            deleteTradeIdEl.value = tradeId;
            deleteModalEl.classList.remove('hidden');
            deleteModalEl.classList.add('flex');
        };

        const openEditModal = ({ id, commodity, buy, sell }) => {
            editTradeIdEl.value = id;
            editBuyAmountEl.value = buy;
            editSellAmountEl.value = sell;
            editModalTitleEl.textContent = `Edit ${commodity} Trade`;
            editErrorMessageEl.classList.add('hidden');
            editModalEl.classList.remove('hidden');
            editModalEl.classList.add('flex');
        };

        const handleTableAction = (e) => {
            const target = e.target.closest('button');
            if (!target) return;
            const tradeId = target.dataset.id;
            if (!tradeId) return;
            if (target.classList.contains('delete-trade-btn')) {
                openDeleteModal(tradeId);
            } else if (target.classList.contains('edit-trade-btn')) {
                const { id, commodity, buy, sell } = target.dataset;
                openEditModal({ id, commodity, buy, sell });
            }
        };

        const renderHistoryTable = (commodity, tableBodyEl, loadingEl) => {
            const filteredTrades = allTradesData.filter(t => t.commodity === commodity);
            tableBodyEl.innerHTML = ''; 
            if (filteredTrades.length === 0) {
                tableBodyEl.innerHTML = `<tr><td colspan="5" class="px-3 py-4 whitespace-nowrap text-center text-sm text-gray-400">No ${commodity} trades recorded yet.</td></tr>`;
                loadingEl.style.display = 'none';
                return;
            }
            let currentWeekNumber = 0;
            const weekMap = {}; 
            filteredTrades.forEach((trade) => {
                const mondayDateString = getMondayOfWeek(trade.timestamp);
                let weekToDisplay;
                if (weekMap[mondayDateString] === undefined) {
                    currentWeekNumber++;
                    weekMap[mondayDateString] = currentWeekNumber;
                }
                weekToDisplay = weekMap[mondayDateString];
                const row = tableBodyEl.insertRow();
                row.className = 'hover:bg-gray-700 transition duration-150';
                row.insertCell().innerHTML = `<div class="px-3 py-4 whitespace-nowrap text-sm font-medium ${commodity === 'gold' ? 'text-yellow-400' : 'text-gray-300'}">${weekToDisplay}</div>`;
                row.insertCell().innerHTML = `<div class="px-3 py-4 whitespace-nowrap text-sm text-gray-300">${trade.date || formatDate(trade.timestamp)}</div>`;
                const buyAmount = trade.buyAmount || 0;
                row.insertCell().innerHTML = `<div class="px-3 py-4 whitespace-nowrap text-sm font-semibold ${buyAmount > 0 ? 'text-green-400' : 'text-gray-500'}">${parseFloat(buyAmount).toFixed(2)}</div>`;
                const sellAmount = trade.sellAmount || 0;
                row.insertCell().innerHTML = `<div class="px-3 py-4 whitespace-nowrap text-sm font-semibold ${sellAmount > 0 ? 'text-red-400' : 'text-gray-500'}">${parseFloat(sellAmount).toFixed(2)}</div>`;
                row.insertCell().innerHTML = `
                    <div class="px-3 py-4 whitespace-nowrap text-sm text-center flex items-center justify-start space-x-2">
                        <button class="edit-trade-btn px-2 py-1 bg-blue-600 text-white text-xs font-semibold rounded-md hover:bg-blue-500 transition duration-150" 
                                data-id="${trade.id}" 
                                data-commodity="${trade.commodity}"
                                data-buy="${buyAmount}"
                                data-sell="${sellAmount}">
                            Edit
                        </button>
                        <button class="delete-trade-btn px-2 py-1 bg-red-600 text-white text-xs font-semibold rounded-md hover:bg-red-500 transition duration-150" 
                                data-id="${trade.id}">
                            Delete
                        </button>
                    </div>`;
            });
            loadingEl.style.display = 'none';
        };

        const updateNetPositionUI = (element, netPosition, commodity) => {
            if (!element) return;
            element.textContent = netPosition.toFixed(2);
            element.classList.remove('text-green-400', 'text-red-400', 'text-gray-300', 'text-yellow-400', 'text-white');
            if (netPosition > 0) element.classList.add('text-green-400');
            else if (netPosition < 0) element.classList.add('text-red-400');
            else {
                if (commodity === 'Gold') element.classList.add('text-yellow-400');
                else if (commodity === 'Silver') element.classList.add('text-gray-300');
                else element.classList.add('text-white');
            }
        };

        const updateDashboardAndReport = (trades) => {
            // This function's logic remains the same
            const goldTrades = trades.filter(t => t.commodity === 'gold');
            const silverTrades = trades.filter(t => t.commodity === 'silver');
            const currentMonday = getMondayOfWeek(new Date());
            let goldTotalBuy_AllTime = 0, goldTotalSell_AllTime = 0;
            goldTrades.forEach(trade => {
                goldTotalBuy_AllTime += (trade.buyAmount || 0);
                goldTotalSell_AllTime += (trade.sellAmount || 0);
            });
            const netGold_AllTime = goldTotalBuy_AllTime - goldTotalSell_AllTime;
            let goldTotalBuy_CurrentWeek = 0, goldTotalSell_CurrentWeek = 0;
            let goldBuyTradeCount_CurrentWeek = 0, goldSellTradeCount_CurrentWeek = 0, goldTotalTradeCount_CurrentWeek = 0; 
            goldTrades.forEach(trade => {
                if (getMondayOfWeek(trade.timestamp) === currentMonday) {
                    goldTotalTradeCount_CurrentWeek++; 
                    const buyAmt = trade.buyAmount || 0;
                    const sellAmt = trade.sellAmount || 0;
                    if (buyAmt > 0) { goldTotalBuy_CurrentWeek += buyAmt; goldBuyTradeCount_CurrentWeek++; }
                    if (sellAmt > 0) { goldTotalSell_CurrentWeek += sellAmt; goldSellTradeCount_CurrentWeek++; }
                }
            });
            const goldAvgBuy_CurrentWeek = goldBuyTradeCount_CurrentWeek > 0 ? (goldTotalBuy_CurrentWeek / goldBuyTradeCount_CurrentWeek) : 0;
            const goldAvgSell_CurrentWeek = goldSellTradeCount_CurrentWeek > 0 ? (goldTotalSell_CurrentWeek / goldSellTradeCount_CurrentWeek) : 0;
            if(goldAvgBuyEl) goldAvgBuyEl.textContent = goldAvgBuy_CurrentWeek.toFixed(2);
            if(goldAvgSellEl) goldAvgSellEl.textContent = goldAvgSell_CurrentWeek.toFixed(2);
            if(goldTradeCountEl) goldTradeCountEl.textContent = `Based on ${goldTotalTradeCount_CurrentWeek} trades this week.`;
            const goldReportText = `Based on ${goldTrades.length} trades. Total Buy: ${goldTotalBuy_AllTime.toFixed(2)}, Total Sell: ${goldTotalSell_AllTime.toFixed(2)}.`;
            if (goldTrades.length === 0) {
                if(goldReportSummaryEl) goldReportSummaryEl.textContent = `Based on 0 trades.`;
                if(goldReportSummarySoloEl) goldReportSummarySoloEl.textContent = `Based on 0 trades.`;
            } else {
                if(goldReportSummaryEl) goldReportSummaryEl.textContent = goldReportText;
                if(goldReportSummarySoloEl) goldReportSummarySoloEl.textContent = goldReportText;
            }
            updateNetPositionUI(goldNetPositionEl, netGold_AllTime, 'Gold');
            updateNetPositionUI(goldNetPositionSoloEl, netGold_AllTime, 'Gold');
            let silverTotalBuy_AllTime = 0, silverTotalSell_AllTime = 0;
            silverTrades.forEach(trade => {
                silverTotalBuy_AllTime += (trade.buyAmount || 0);
                silverTotalSell_AllTime += (trade.sellAmount || 0);
            });
            const netSilver_AllTime = silverTotalBuy_AllTime - silverTotalSell_AllTime;
            let silverTotalBuy_CurrentWeek = 0, silverTotalSell_CurrentWeek = 0;
            let silverBuyTradeCount_CurrentWeek = 0, silverSellTradeCount_CurrentWeek = 0, silverTotalTradeCount_CurrentWeek = 0;
            silverTrades.forEach(trade => {
                if (getMondayOfWeek(trade.timestamp) === currentMonday) {
                    silverTotalTradeCount_CurrentWeek++; 
                    const buyAmt = trade.buyAmount || 0;
                    const sellAmt = trade.sellAmount || 0;
                    if (buyAmt > 0) { silverTotalBuy_CurrentWeek += buyAmt; silverBuyTradeCount_CurrentWeek++; }
                    if (sellAmt > 0) { silverTotalSell_CurrentWeek += sellAmt; silverSellTradeCount_CurrentWeek++; }
                }
            });
            const silverAvgBuy_CurrentWeek = silverBuyTradeCount_CurrentWeek > 0 ? (silverTotalBuy_CurrentWeek / silverBuyTradeCount_CurrentWeek) : 0;
            const silverAvgSell_CurrentWeek = silverSellTradeCount_CurrentWeek > 0 ? (silverTotalSell_CurrentWeek / silverSellTradeCount_CurrentWeek) : 0;
            if(silverAvgBuyEl) silverAvgBuyEl.textContent = silverAvgBuy_CurrentWeek.toFixed(2);
            if(silverAvgSellEl) silverAvgSellEl.textContent = silverAvgSell_CurrentWeek.toFixed(2);
            if(silverTradeCountEl) silverTradeCountEl.textContent = `Based on ${silverTotalTradeCount_CurrentWeek} trades this week.`;
            const silverReportText = `Based on ${silverTrades.length} trades. Total Buy: ${silverTotalBuy_AllTime.toFixed(2)}, Total Sell: ${silverTotalSell_AllTime.toFixed(2)}.`;
            if (silverTrades.length === 0) {
                if(silverReportSummaryEl) silverReportSummaryEl.textContent = `Based on 0 trades.`;
                if(silverReportSummarySoloEl) silverReportSummarySoloEl.textContent = `Based on 0 trades.`;
            } else {
                if(silverReportSummaryEl) silverReportSummaryEl.textContent = silverReportText;
                if(silverReportSummarySoloEl) silverReportSummarySoloEl.textContent = silverReportText;
            }
            updateNetPositionUI(silverNetPositionEl, netSilver_AllTime, 'Silver');
            updateNetPositionUI(silverNetPositionSoloEl, netSilver_AllTime, 'Silver');
            const netCombined_AllTime = netGold_AllTime + netSilver_AllTime;
            const combinedReportText = `Combined net position across ${goldTrades.length + silverTrades.length} total trades.`;
            if(combinedReportSummaryEl) combinedReportSummaryEl.textContent = combinedReportText;
            updateNetPositionUI(combinedNetPositionEl, netCombined_AllTime, 'Combined');
        };

        // --- Page Routing ---
        
        const showReportSubView = (hash) => {
            if (hash === '#report') hash = '#report-overall';
            const viewMap = {
                '#report-overall': reportOverallViewEl,
                '#report-gold': reportGoldViewEl,
                '#report-silver': reportSilverViewEl
            };
            Object.values(viewMap).forEach(el => { if(el) el.style.display = 'none'; });
            reportNavLinks.forEach(link => {
                link.classList.remove('bg-green-600', 'text-white', 'hover:bg-green-500');
                link.classList.add('text-gray-300', 'hover:bg-gray-700');
            });
            const targetEl = viewMap[hash];
            if (targetEl) {
                targetEl.style.display = 'block';
                const activeLink = document.querySelector(`.report-nav-link[href="${hash}"]`);
                if(activeLink) {
                    activeLink.classList.remove('text-gray-300', 'hover:bg-gray-700');
                    activeLink.classList.add('bg-green-600', 'text-white', 'hover:bg-green-500');
                }
            } else {
                if(reportOverallViewEl) reportOverallViewEl.style.display = 'block';
                const activeLink = document.querySelector('.report-nav-link[href="#report-overall"]');
                if(activeLink) {
                    activeLink.classList.remove('text-gray-300', 'hover:bg-gray-700');
                    activeLink.classList.add('bg-green-600', 'text-white', 'hover:bg-green-500');
                }
            }
        };
 
        // This shows pages *within* the main app
        const showAppView = (hash) => {
            const viewMap = {
                '#dashboard': dashboardViewEl,
                '#gold': goldViewEl,
                '#silver': silverViewEl,
                '#report': reportViewEl,
                '#profile': profileViewEl
            };

            Object.values(viewMap).forEach(el => el.style.display = 'none');
            navLinks.forEach(link => {
                link.classList.remove('bg-yellow-600', 'bg-blue-600', 'bg-green-600', 'text-gray-900', 'text-white');
                link.classList.add('text-gray-300');
            });

            const targetEl = viewMap[hash];
            if (targetEl) {
                targetEl.style.display = 'block';
                const activeLink = document.querySelector(`.nav-link[href="${hash}"]`);
                if (activeLink) {
                    activeLink.classList.remove('text-gray-300');
                    if (hash === '#gold') activeLink.classList.add('bg-yellow-600', 'text-gray-900', 'hover:bg-yellow-500');
                    else if (hash === '#silver') activeLink.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-500');
                    else if (hash === '#report') activeLink.classList.add('bg-green-600', 'text-white', 'hover:bg-green-500');
                    else if (hash === '#profile') activeLink.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-500');
                    else activeLink.classList.add('bg-yellow-600', 'text-gray-900', 'hover:bg-yellow-500');
                }
            } else {
                window.location.hash = '#dashboard'; // Default to dashboard if logged in
            }
        };

        // This shows the Login or Register pages
        const showAuthView = (hash) => {
            if (hash === '#register') {
                loginViewEl.style.display = 'none';
                registerViewEl.style.display = 'block';
            } else {
                loginViewEl.style.display = 'block';
                registerViewEl.style.display = 'none';
            }
        };

        const handleHashChange = () => {
            let hash = window.location.hash || '#login';
            
            if (auth && auth.currentUser) { // User is LOGGED IN
                if (hash === '#login' || hash === '#register') {
                    window.location.hash = '#dashboard'; // Redirect to app
                    return;
                }
                if (hash.startsWith('#report')) {
                    showAppView('#report'); 
                    showReportSubView(hash);
                } else {
                    showAppView(hash); // Show app page
                }
            } else { // User is LOGGED OUT
                if (hash === '#login' || hash === '#register') {
                    showAuthView(hash); // Show auth page
                } else {
                    window.location.hash = '#login'; // Redirect to login
                }
            }
        };
 
        window.addEventListener('hashchange', handleHashChange);
        
        // --- Firebase Service (No longer needs to be an object) ---

        const getTradesCollectionPath = () => {
            if (!userId) {
                console.error("User ID is not available.");
                return null;
            }
            return `artifacts/${appId}/users/${userId}/commodity_trades`;
        };

        const listenForTrades = () => {
            if (unsubscribeFromTrades) unsubscribeFromTrades(); // Stop old listener
            const path = getTradesCollectionPath();
            if (!path) return;
            const q = query(collection(db, path));
            unsubscribeFromTrades = onSnapshot(q, (querySnapshot) => {
                const trades = [];
                querySnapshot.forEach((doc) => {
                    trades.push({ id: doc.id, ...doc.data() });
                });
                allTradesData = trades;
                updateAllUI();
            }, (error) => {
                console.error("Error listening to trades:", error);
                showModal("Real-time Error", "Failed to load real-time trade data.");
            });
        };

        const saveTrade = async (tradeData, commodity) => {
            if (!db || !userId) {
                showModal("Error", "Database not ready or user not authenticated.");
                return;
            }
            const path = getTradesCollectionPath();
            if (!path) return;
            try {
                await addDoc(collection(db, path), {
                    ...tradeData,
                    commodity: commodity,
                    timestamp: serverTimestamp(), 
                    date: toStorageDate(new Date()), 
                });
                if(commodity === 'gold') goldTradeFormEl.reset();
                else silverTradeFormEl.reset();
                window.location.hash = '#dashboard';
            } catch (e) {
                console.error("Error adding document: ", e);
                showModal("Save Error", "Failed to save the trade entry.");
            }
        };

        const deleteTrade = async (tradeId) => {
            if (!db || !userId || !tradeId) {
                showModal("Error", "Database not ready or trade ID missing.");
                return;
            }
            const tradeDocRef = doc(db, getTradesCollectionPath(), tradeId);
            try {
                await deleteDoc(tradeDocRef);
                deleteModalEl.classList.add('hidden');
                deleteModalEl.classList.remove('flex');
            } catch (error) {
                console.error("Error deleting trade: ", error);
                showModal("Delete Error", "Could not delete the trade.");
            }
        };

        const updateTrade = async (tradeId, newData) => {
            if (!db || !userId) {
                showModal("Error", "Database not ready.");
                return;
            }
            const tradeDocRef = doc(db, getTradesCollectionPath(), tradeId);
            try {
                await updateDoc(tradeDocRef, newData);
                editModalEl.classList.add('hidden');
                editModalEl.classList.remove('flex');
            } catch (error) {
                console.error("Error updating trade: ", error);
                editErrorMessageEl.textContent = "Could not save changes.";
                editErrorMessageEl.classList.remove('hidden');
            }
        };

        const clearAllData = async () => {
            if (!db || !userId) {
                showModal("Error", "Database not ready.");
                return;
            }
            // We must delete all docs in the collection.
            // This is safer than deleting the collection itself.
            // Get all docs, then batch delete.
            try {
                const path = getTradesCollectionPath();
                const q = query(collection(db, path));
                const querySnapshot = await getDocs(q); // Use getDocs for one-time read
                
                const batch = writeBatch(db);
                querySnapshot.forEach((doc) => {
                    batch.delete(doc.ref);
                });
                await batch.commit();

                // onSnapshot will automatically update the UI to be empty
                allTradesData = []; // Manually clear cache just in case
                updateAllUI();
                
            } catch (error) {
                 console.error("Error clearing all data: ", error);
                showModal("Error", "Could not clear all data. See console.");
            }
        };
        

        // --- Event Listeners ---

        const handleTradeSubmit = (e, commodity) => {
            e.preventDefault();
            const [buyInputId, sellInputId, errorMsgEl] = commodity === 'gold' 
                ? ['gold-buy-amount', 'gold-sell-amount', goldErrorMessageEl]
                : ['silver-buy-amount', 'silver-sell-amount', silverErrorMessageEl];
            if(!errorMsgEl) return;
            errorMsgEl.classList.add('hidden');
            const buyAmountStr = document.getElementById(buyInputId).value;
            const sellAmountStr = document.getElementById(sellInputId).value;
            const buyAmount = buyAmountStr === '' ? 0 : parseFloat(buyAmountStr);
            const sellAmount = sellAmountStr === '' ? 0 : parseFloat(sellAmountStr);
            if (isNaN(buyAmount) || isNaN(sellAmount)) {
                errorMsgEl.textContent = "Please enter valid numbers.";
                errorMsgEl.classList.remove('hidden');
                return;
            }
            if (buyAmount === 0 && sellAmount === 0) {
                errorMsgEl.textContent = "Please enter a Buy or Sell Amount.";
                errorMsgEl.classList.remove('hidden');
                return;
            }
            saveTrade({ buyAmount, sellAmount }, commodity);
        };

        if(goldTradeFormEl) goldTradeFormEl.addEventListener('submit', (e) => handleTradeSubmit(e, 'gold'));
        if(silverTradeFormEl) silverTradeFormEl.addEventListener('submit', (e) => handleTradeSubmit(e, 'silver'));

        if(editCancelButtonEl) editCancelButtonEl.addEventListener('click', () => {
            editModalEl.classList.add('hidden');
            editModalEl.classList.remove('flex');
        });
        
        if(editTradeFormEl) editTradeFormEl.addEventListener('submit', (e) => {
            e.preventDefault();
            if(editErrorMessageEl) editErrorMessageEl.classList.add('hidden');
            const tradeId = editTradeIdEl.value;
            const buyAmountStr = editBuyAmountEl.value;
            const sellAmountStr = editSellAmountEl.value;
            const buyAmount = buyAmountStr === '' ? 0 : parseFloat(buyAmountStr);
            const sellAmount = sellAmountStr === '' ? 0 : parseFloat(sellAmountStr);
            if (isNaN(buyAmount) || isNaN(sellAmount)) {
                if(editErrorMessageEl) {
                    editErrorMessageEl.textContent = "Please enter valid numbers.";
                    editErrorMessageEl.classList.remove('hidden');
                }
                return;
            }
            if (buyAmount === 0 && sellAmount === 0) {
                if(editErrorMessageEl) {
                    editErrorMessageEl.textContent = "Please enter a Buy or Sell Amount.";
                    editErrorMessageEl.classList.remove('hidden');
                }
                return;
            }
            updateTrade(tradeId, { buyAmount, sellAmount });
        });
        
        if(deleteCancelButtonEl) deleteCancelButtonEl.addEventListener('click', () => {
            deleteModalEl.classList.add('hidden');
            deleteModalEl.classList.remove('flex');
        });
        
        if(deleteConfirmButtonEl) deleteConfirmButtonEl.addEventListener('click', () => {
            const tradeId = deleteTradeIdEl.value;
            deleteTrade(tradeId);
        });

        // Clear All Data Listeners
        if(clearAllDataButtonEl) clearAllDataButtonEl.addEventListener('click', () => {
            clearDataModalEl.classList.remove('hidden');
            clearDataModalEl.classList.add('flex');
        });
        if(clearDataCancelButtonEl) clearDataCancelButtonEl.addEventListener('click', () => {
            clearDataModalEl.classList.add('hidden');
            clearDataModalEl.classList.remove('flex');
        });
        if(clearDataConfirmButtonEl) clearDataConfirmButtonEl.addEventListener('click', () => {
            try {
                clearAllData(); // Use new cloud function
                clearDataModalEl.classList.add('hidden');
                clearDataModalEl.classList.remove('flex');
                showModal("Success", "All trade data has been cleared.");
            } catch (error) {
                console.error("Error clearing data: ", error);
                showModal("Error", "Could not clear all data.");
            }
        });

        if(goldTradesBodyEl) goldTradesBodyEl.addEventListener('click', handleTableAction);
        if(silverTradesBodyEl) silverTradesBodyEl.addEventListener('click', handleTableAction);

        // --- NEW AUTH LISTENERS ---

        if(loginFormEl) loginFormEl.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginErrorEl.classList.add('hidden');
            const username = document.getElementById('login-username').value; // This is the mobile number
            const password = document.getElementById('login-password').value;
            try {
                // FIX: Add prefix to make the email valid
                const loginEmail = PHONE_PREFIX + username + FAKE_DOMAIN;
                await signInWithEmailAndPassword(auth, loginEmail, password); 
                // onAuthStateChanged will handle the UI update
            } catch (error) {
                console.error("Login failed:", error);
                // Handle common errors
                if (error.code === 'auth/operation-not-allowed') {
                    loginErrorEl.textContent = "Email/Password login is not enabled for this project.";
                    showModal("Configuration Error", "Login failed because the 'Email/Password' sign-in method is not enabled in your Firebase project. Please enable it in the Firebase Console -> Authentication -> Sign-in method.");
                } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    loginErrorEl.textContent = "Invalid mobile number or password.";
                } else if (error.code === 'auth/invalid-email') {
                    // FIX: Add specific error for this
                    loginErrorEl.textContent = "An internal error occurred. Please try again.";
                    console.error("Login email format was invalid:", PHONE_PREFIX + username + FAKE_DOMAIN);
                } else {
                    loginErrorEl.textContent = "An unknown error occurred. Please try again.";
                }
                loginErrorEl.classList.remove('hidden');
            }
        });

        if(registerFormEl) registerFormEl.addEventListener('submit', async (e) => {
            e.preventDefault();
            registerErrorEl.classList.add('hidden');
            const username = document.getElementById('register-username').value; // This is the mobile number
            const password = document.getElementById('register-password').value;

            // UPDATED Validation for 10-digit number
            const phoneRegex = /^\d{10}$/;
            if (!phoneRegex.test(username)) {
                registerErrorEl.textContent = "Please enter a valid 10-digit mobile number.";
                registerErrorEl.classList.remove('hidden');
                return;
            }

            try {
                // FIX: Add prefix to make the email valid
                const registerEmail = PHONE_PREFIX + username + FAKE_DOMAIN;
                await createUserWithEmailAndPassword(auth, registerEmail, password); 
                // onAuthStateChanged will handle the UI update
            } catch (error) {
                console.error("Registration failed:", error);
                // Handle common errors
                if (error.code === 'auth/operation-not-allowed') {
                    registerErrorEl.textContent = "Email/Password sign-up is not enabled for this project.";
                     showModal("Configuration Error", "Registration failed because the 'Email/Password' sign-in method is not enabled in your Firebase project. Please enable it in the Firebase Console -> Authentication -> Sign-in method.");
                } else if (error.code === 'auth/email-already-in-use') {
                    registerErrorEl.textContent = "This mobile number is already taken. Please choose another.";
                } else if (error.code === 'auth/weak-password') {
                     registerErrorEl.textContent = "Password is too weak. Must be at least 6 characters.";
                } else {
                    registerErrorEl.textContent = "An unknown error occurred. Please try again.";
                }
                registerErrorEl.classList.remove('hidden');
            }
        });

        if(signOutButtonEl) signOutButtonEl.addEventListener('click', async () => {
            try {
                await signOut(auth);
                // onAuthStateChanged will handle the UI update
            } catch (error) {
                console.error("Sign out failed:", error);
                showModal("Error", "Could not sign out.");
            }
        });

        // Auth view toggle links
        if(gotoRegisterLinkEl) gotoRegisterLinkEl.addEventListener('click', (e) => { e.preventDefault(); window.location.hash = '#register'; });
        if(gotoLoginLinkEl) gotoLoginLinkEl.addEventListener('click', (e) => { e.preventDefault(); window.location.hash = '#login'; });


        // NEW: Gemini Insights Button Listener
        if(insightsButton) {
            insightsButton.addEventListener('click', async () => {
                if(insightsLoading) insightsLoading.style.display = 'flex';
                if(insightsContent) insightsContent.innerHTML = '';
                if(insightsSources) insightsSources.innerHTML = '';
                insightsButton.disabled = true;

                const prompt = "Provide a very brief, one-paragraph summary of the latest market news and price trends for Gold and Silver commodities.";

                try {
                    const { text, sources } = await callGeminiApi(prompt, true); // Enable grounding
                    
                    if(insightsContent) {
                        // Replace newlines with <br> tags for proper HTML rendering
                        insightsContent.innerHTML = text.replace(/\n/g, '<br>');
                    }

                    if (insightsSources && sources.length > 0) {
                        let sourcesHtml = '<h4 class="text-sm font-semibold text-gray-300 mt-4 mb-2">Sources:</h4><ul class="list-disc list-inside space-y-1">';
                        sources.forEach(source => {
                            // Truncate long titles for better UI
                            const title = source.title.length > 80 ? source.title.substring(0, 80) + '...' : source.title;
                            sourcesHtml += `<li><a href="${source.uri}" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:underline" title="${source.title}">${title}</a></li>`;
                        });
                        sourcesHtml += '</ul>';
                        insightsSources.innerHTML = sourcesHtml;
                    }

                } catch (error) {
                    console.error("Failed to get market insights:", error);
                    if(insightsContent) insightsContent.innerHTML = `<p class="text-red-400">Could not load insights. ${error.message}</p>`;
                } finally {
                    if(insightsLoading) insightsLoading.style.display = 'none';
                    insightsButton.disabled = false;
                }
            });
        }


        // --- Initial Page Load ---
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // Check if the placeholder is still being used
                if (hardcodedFirebaseConfig.apiKey === "YOUR_API_KEY" && !initialAuthToken) {
                    showModal("Configuration Error", "You have not configured your Firebase project. Please follow the instructions on the 'Profile' page (once logged in) or in the code comments to set up your firebaseConfig.");
                    // We can't proceed, but we can set up the auth UI
                    mainAppContainerEl.classList.add('hidden');
                    authContainerEl.style.display = 'block';
                    handleHashChange(); // Show login page
                    return; // Stop initialization
                }

                setLogLevel('debug');
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                if(authStatusEl) authStatusEl.textContent = 'Initializing...';
                
                // This is the new "main" function
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // USER IS LOGGED IN
                        userId = user.uid;
                        // FIX: Extract mobile number correctly using the prefix
                        username = user.email.replace(PHONE_PREFIX, "").split('@')[0];
                        
                        // Update UI
                        mainAppContainerEl.classList.remove('hidden');
                        authContainerEl.style.display = 'none'; // Use style.display to remove from flow
                        authFooterEl.classList.add('hidden');
                        appFooterEl.classList.remove('hidden');
                        if(userUsernameDisplayEl) userUsernameDisplayEl.textContent = username; // CHANGED (now shows number)
                        if(footerUserUsernameEl) footerUserUsernameEl.textContent = username; // CHANGED (now shows number)
                        if(authStatusEl) authStatusEl.textContent = 'Authenticated successfully.';
                        if(goldSubmitButton) goldSubmitButton.disabled = false;
                        if(silverSubmitButton) silverSubmitButton.disabled = false;

                        // Start data listeners
                        listenForTrades(); 
                        
                    } else {
                        // USER IS LOGGED OUT
                        userId = null;
                        username = null; // CHANGED (clears number)
                        if (unsubscribeFromTrades) unsubscribeFromTrades(); // Stop listening
                        allTradesData = []; // Clear data cache
                        updateAllUI(); // Clear UI
                        
                        // Update UI
                        mainAppContainerEl.classList.add('hidden');
                        authContainerEl.style.display = 'block';
                        authFooterEl.classList.remove('hidden');
                        appFooterEl.classList.add('hidden');
                        if(goldSubmitButton) goldSubmitButton.disabled = true;
                        if(silverSubmitButton) silverSubmitButton.disabled = true;
                    }
                    
                    // Always run the router to show the correct page
                    handleHashChange();
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                if(authStatusEl) authStatusEl.textContent = 'Error initializing Firebase.';
                showModal("Firebase Error", "Could not initialize Firebase. Please check your config.");
                // Show auth view even if Firebase fails, so user isn't stuck
                mainAppContainerEl.classList.add('hidden');
                authContainerEl.style.display = 'block';
                handleHashChange();
            }
        });
        
    </script>
</body>
</html>